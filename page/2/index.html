<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="çŸ¥è¯†æ€»ç»“">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="çŸ¥è¯†æ€»ç»“">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="çŸ¥è¯†æ€»ç»“">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/2/"/>





  <title>çŸ¥è¯†æ€»ç»“</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">çŸ¥è¯†æ€»ç»“</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/06/25/cpu/cpu_freq/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="dongka">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="çŸ¥è¯†æ€»ç»“">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/25/cpu/cpu_freq/" itemprop="url">CPUFreq</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-06-25T00:07:09+00:00">
                2018-06-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/cpu/" itemprop="url" rel="index">
                    <span itemprop="name">cpu</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1><span id="ä»£ç ä¸»è¦çš„åŠŸèƒ½">ä»£ç ä¸»è¦çš„åŠŸèƒ½</span></h1><p>1) å¹³å°ç›¸å…³çš„åˆå§‹åŒ–åŠ¨ä½œï¼ŒåŒ…æ‹¬CPU coreçš„clock/regulatorè·å–ï¼Œåˆå§‹åŒ–<br>2) ç”Ÿæˆfrequency table,å³ CPU coreæ‰€æ”¯æŒçš„é¢‘ç‡/ç”µå‹åˆ—è¡¨ã€‚å¹¶åœ¨åˆå§‹åŒ–çš„æ—¶å€™å°†è¯¥tableä¿å­˜åœ¨policy<br>3) å®šä¹‰ä¸€ä¸ªstrcut cpufreq_driverå˜é‡ï¼Œå¡«å……å¿…è¦çš„å­—æ®µï¼Œå¹¶æ ¹æ®å¹³å°çš„ç‰¹æ€§ï¼Œå®ç°å…¶ä¸­çš„å›è°ƒå‡½æ•°ï¼›<br>4) è°ƒç”¨cpufreq_register_driverå°†driveræ³¨å†Œåˆ°cpufreq frameworkä¸­<br>5) cpufreq coreä¼šåœ¨CPUè®¾å¤‡æ·»åŠ æ—¶ï¼Œè°ƒç”¨driverçš„initæ¥å£ã€‚driveréœ€è¦åœ¨æ¥å£ä¸­åˆå§‹åŒ–struct cpufreqå˜é‡<br>6) ç³»ç»Ÿè¿è¡Œè¿‡ç¨‹ä¸­ï¼Œcpufreq coreä¼šæ ¹æ®å®é™…æƒ…å†µï¼Œè°ƒç”¨driverçš„sepolicyæˆ–è€…target/target_indexç­‰æ¥å£ï¼Œè®¾ç½®<br>CPUçš„è°ƒé¢‘ç­–ç•¥æˆ–è€…é¢‘ç‡å€¼<br>7) ç³»ç»Ÿsuspendçš„æ—¶å€™ï¼Œä¼šå°†CPUçš„é¢‘ç‡è®¾ç½®ä¸ºæŒ‡å®šçš„å€¼ï¼Œæˆ–è€…è°ƒç”¨driverçš„suspendå›è°ƒå‡½æ•°ï¼›ç³»ç»Ÿresumeæ—¶è°ƒç”¨driverçš„resumeå›è°ƒå‡½æ•°ï¼›</p>
<h1><span id="cpufreq-driver">cpufreq driver</span></h1><p>frequency tableæ˜¯CPU coreå¯ä»¥æ­£ç¡®è¿è¡Œçš„ä¸€ç»„é¢‘ç‡/ç”µå‹ç»„åˆ</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/06/25/process/process_day1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="dongka">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="çŸ¥è¯†æ€»ç»“">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/25/process/process_day1/" itemprop="url">è¿›ç¨‹åˆè¯†</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-06-25T00:07:09+00:00">
                2018-06-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/è¿›ç¨‹/" itemprop="url" rel="index">
                    <span itemprop="name">è¿›ç¨‹</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1><span id="ä¸€è¿›ç¨‹ç»“æ„ä½“">ä¸€ï¼šè¿›ç¨‹ç»“æ„ä½“</span></h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">å£°æ˜ç›®å½•ï¼šinclude/linux/sched.h</span><br></pre></td></tr></table></figure>
<h2><span id="è¿›ç¨‹çš„çŠ¶æ€">è¿›ç¨‹çš„çŠ¶æ€</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">volatile long state; /* -1 unrunnable, 0 runnable, &gt;0 stopped */ </span><br><span class="line">//1. R:è¿è¡Œ(æ­£åœ¨è¿è¡Œæˆ–åœ¨è¿è¡Œé˜Ÿåˆ—ä¸­ç­‰å¾…)</span><br><span class="line">//2. S:ä¸­æ–­(ä¼‘çœ ä¸­ï¼Œå—é˜»ï¼Œåœ¨ç­‰å¾…æŸä¸ªæ¡ä»¶å½¢æˆæˆ–æ¥å—åˆ°ä¿¡å·)</span><br><span class="line">//3. D:ä¸å¯ä¸­æ–­(æ”¶åˆ°ä¿¡å·ä¸å”¤é†’å’Œä¸å¯è¿è¡Œï¼Œè¿›ç¨‹å¿…é¡»ç­‰å¾…ç›´åˆ°æœ‰ä¸­æ–­å‘ç”Ÿ): </span><br><span class="line">//4. T:åƒµæ­»(è¿›ç¨‹å·²ç»ˆæ­¢ï¼Œä½†è¿›ç¨‹æè¿°ç¬¦å­˜åœ¨ï¼Œç›´åˆ°çˆ¶è¿›ç¨‹è°ƒç”¨wait4()ç³»ç»Ÿè°ƒç”¨åé‡Šæ”¾)</span><br><span class="line">//5. Z:åœæ­¢(è¿›ç¨‹æ”¶åˆ°SIGSTOP,STGSTP,SIGIN,SIGOUä¿¡å·ååœæ­¢è¿è¡Œ)</span><br></pre></td></tr></table></figure>
<p><img src="/2018/06/25/process/process_day1/process_life.jpg" alt="è¿›ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ"></p>
<h2><span id="è¿›ç¨‹çš„è¿›ç¨‹æ ‡è¯†">è¿›ç¨‹çš„è¿›ç¨‹æ ‡è¯†</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pid_t pid;</span><br><span class="line">pid_t tgid;</span><br></pre></td></tr></table></figure>
<p>åœ¨linuxç³»ç»Ÿä¸­ï¼Œæ‰€æœ‰è¿›ç¨‹éƒ½æœ‰ç›´æ¥æˆ–é—´æ¥çš„è”ç³»ï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½æœ‰å…¶çˆ¶è¿›ç¨‹<br>linuxæŠŠä¸åŒçš„pidä¸ç³»ç»Ÿä¸­çš„æ¯ä¸ªè¿›ç¨‹æˆ–è½»é‡çº§çº¿ç¨‹å…³è”ï¼Œä¸€ä¸ªçº¿ç¨‹ç»„æ‰€æœ‰çº¿ç¨‹ä¸é›¶å¤´çº¿ç¨‹å…·æœ‰ç›¸åŒçš„pid,å­˜å…¥tgidä¸­ï¼›</p>
<h2><span id="è¿›ç¨‹æ ‡è®°">è¿›ç¨‹æ ‡è®°</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unsigned int flags;</span><br></pre></td></tr></table></figure>
<p>ååº”è¿›ç¨‹çŠ¶æ€ä¿¡æ¯,ä½†ä¸æ˜¯è¿è¡ŒçŠ¶æ€ï¼Œç”¨äºå†…æ ¸è¯†åˆ«è¿›ç¨‹å½“å‰çš„çŠ¶æ€ï¼Œä»¥å¤‡ä¸‹ä¸€æ­¥æ“ä½œ</p>
<h2><span id="è¡¨ç¤ºè¿›ç¨‹äº²å±å…³ç³»çš„æˆå‘˜">è¡¨ç¤ºè¿›ç¨‹äº²å±å…³ç³»çš„æˆå‘˜</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">/*  </span><br><span class="line"> * pointers to (original) parent process, youngest child, younger sibling,</span><br><span class="line"> * older sibling, respectively.  (p-&gt;father can be replaced with</span><br><span class="line"> * p-&gt;real_parent-&gt;pid)</span><br><span class="line"> */</span><br><span class="line"> struct task_struct __rcu *real_parent; /* real parent process */</span><br><span class="line"> struct task_struct __rcu *parent; /* recipient of SIGCHLD, wait4() reports */</span><br><span class="line">/*   </span><br><span class="line"> * children/sibling forms the list of my natural children</span><br><span class="line">*/</span><br><span class="line"> struct list_head children;      /* list of my children */</span><br><span class="line"> struct list_head sibling;       /* linkage in my parent&apos;s children list */</span><br><span class="line"> struct task_struct *group_leader;       /* threadgroup leader */</span><br></pre></td></tr></table></figure>
<h2><span id="è¿›ç¨‹å†…æ ¸æ ˆ">è¿›ç¨‹å†…æ ¸æ ˆ</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">struct thread_info thread_info;</span><br><span class="line">void *stack;</span><br></pre></td></tr></table></figure>
<h2><span id="ptraceç³»ç»Ÿè°ƒç”¨">ptraceç³»ç»Ÿè°ƒç”¨</span></h2><p>æä¾›ä¸€ç§çˆ¶è¿›ç¨‹å¯ä»¥æ§åˆ¶å­è¿›ç¨‹è¿è¡Œ,å¹¶å¯ä»¥æ£€æŸ¥å’Œæ”¹å˜å®ƒçš„æ ¸å¿ƒimage;</p>
<h2><span id="ä¼˜å…ˆçº§">ä¼˜å…ˆçº§</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">int prio,ä¿å­˜é™æ€ä¼˜å…ˆçº§ï¼Œå¯ä»¥é€šè¿‡niceç³»ç»Ÿè°ƒç”¨æ¥è¿›è¡Œä¿®æ”¹</span><br><span class="line">rt_prority,ç”¨äºä¿å­˜å®æ—¶ä¼˜å…ˆçº§</span><br><span class="line">normal_prio å–å†³äºé™æ€ä¼˜å…ˆçº§å’Œè°ƒåº¦ç­–ç•¥</span><br><span class="line">prio ç”¨äºä¿å­˜åŠ¨æ€ä¼˜å…ˆçº§</span><br></pre></td></tr></table></figure>
<h2><span id="è°ƒåº¦ç­–ç•¥ç›¸å…³å­—æ®µ">è°ƒåº¦ç­–ç•¥ç›¸å…³å­—æ®µ</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">policy è°ƒåº¦ç­–ç•¥</span><br><span class="line">sched_class è°ƒåº¦ç±»</span><br></pre></td></tr></table></figure>
<h1><span id="task_structçš„åˆå§‹åŒ–">task_structçš„åˆå§‹åŒ–</span></h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">__mmap_switched_data  arch/arm/kernel/head-common.S</span><br><span class="line">  --&gt;__mmap_switched_data</span><br><span class="line">     --&gt;.long   init_thread_union + THREAD_START_SP @ sp</span><br><span class="line">         --&gt; INIT_THREAD_INFO(init_task) init/init_task</span><br></pre></td></tr></table></figure>
<p><code>`</code></p>
<h1><span id="initè¿›ç¨‹">initè¿›ç¨‹</span></h1><p>linuxä¸‹æœ‰3ä¸ªç‰¹æ®Šçš„è¿›ç¨‹ï¼Œidleè¿›ç¨‹ï¼ˆPID=0ï¼‰,initè¿›ç¨‹(PID=1)å’Œkthreadd(PID=2)<br><em>ildeè¿›ç¨‹ç”±ç³»ç»Ÿè‡ªåŠ¨åˆ›å»ºï¼Œè¿è¡Œåœ¨å†…æ ¸æ€<br>idleè¿›ç¨‹å…¶pid=0,å…¶å‰èº«æ˜¯ç³»ç»Ÿåˆ›å»ºçš„ç¬¬ä¸€ä¸ªè¿›ç¨‹ï¼Œä¹Ÿæ˜¯å”¯ä¸€ä¸€ä¸ªæ²¡æœ‰é€šè¿‡forkæˆ–è€…kernel_threadäº§ç”Ÿçš„è¿›ç¨‹ã€‚å®ŒæˆåŠ è½½ç³»ç»Ÿåï¼Œæ¼”å˜æˆä¸ºè¿›ç¨‹è°ƒåº¦ï¼Œäº¤æ¢;
</em>initè¿›ç¨‹ç”±idleé€šè¿‡kernel_threadåˆ›å»ºï¼Œåœ¨å†…æ ¸ç©ºé—´ä¸­å®Œæˆåˆå§‹åŒ–åï¼ŒåŠ è½½initç¨‹åº;</p>
<h1><span id="ä¸‰åƒµå°¸è¿›ç¨‹">ä¸‰ï¼šåƒµå°¸è¿›ç¨‹</span></h1><h1><span id="å…¶ä»–">å…¶ä»–</span></h1><p> å½“ä¸€ä¸ªè¿›ç¨‹åœ¨æ‰§è¡Œæ—¶ï¼ŒCPUçš„æ‰€æœ‰å¯„å­˜å™¨ä¸­çš„å€¼ï¼Œè¿›ç¨‹çš„çŠ¶æ€ä»¥åŠå †æ ˆä¸­çš„å†…å®¹è¢«ç§°ä¸ºè¯¥è¿›ç¨‹ä¸­çš„ä¸Šä¸‹æ–‡ã€‚å½“å†…æ ¸éœ€è¦åˆ‡æ¢åˆ°å¦å¤–ä¸€ä¸ªè¿›ç¨‹æ—¶ï¼Œå®ƒéœ€è¦ä¿å­˜å½“å‰çš„æ‰€æœ‰çŠ¶æ€ï¼Œå³ä¿å­˜å½“å‰è¿›ç¨‹çš„ä¸Šä¸‹æ–‡;ä»¥ä¾¿åœ¨å†æ¬¡æ‰§è¡Œè¯¥è¿›ç¨‹æ—¶ï¼Œèƒ½å¤Ÿå¿…å¾—åˆ°åˆ‡æ¢æ—¶çš„çŠ¶æ€æ‰§è¡Œä¸‹å»ã€‚åœ¨linuxä¸­ï¼Œå½“å‰è¿›ç¨‹ä¸Šä¸‹æ–‡å‡ä¿å­˜åœ¨ä»»åŠ¡æ•°æ®ç»“æ„ä¸­ï¼›<br> å½“å‘ç”Ÿä¸­æ–­æ—¶ï¼Œå†…æ ¸å°±åœ¨è¢«ä¸­æ–­çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œåœ¨å†…æ ¸æ€ä¸‹æ‰§è¡Œä¸­æ–­æœåŠ¡å†ç¨‹ã€‚ä½†åŒæ—¶ä¼šä¿ç•™æ‰€æœ‰éœ€è¦ç”¨åˆ°çš„èµ„æºï¼Œä»¥ä¾¿ä¸­ç»§æœåŠ¡ç»“æŸæ—¶èƒ½æ¢å¤è¢«ä¸­æ–­è¿›ç¨‹çš„æ‰§è¡Œï¼›</p>
<h1><span id="è¿›ç¨‹ä¼˜å…ˆçº§">è¿›ç¨‹ä¼˜å…ˆçº§</span></h1><p>è®¾ç½®SCHED_FIFOå’Œ50 RTä¼˜å…ˆçº§</p>
<p>#chrt -f -a -p 50 10576<br>è®¾ç½®nice</p>
<p>#renice -n -5 -g 9394</p>
<p>#nice -n 5 ./a.out</p>
<h1><span id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</span></h1><p><a href="https://www.ibm.com/developerworks/cn/linux/l-cn-scheduler/index.html" target="_blank" rel="noopener">linuxè°ƒåº¦å™¨å‘å±•ç®€è¿°</a><br><a href="https://blog.csdn.net/gatieme/article/details/51383272" target="_blank" rel="noopener">linuxè¿›ç¨‹æè¿°ç¬¦task_structç»“æ„ä½“è¯¦è§£â€“linuxè¿›ç¨‹çš„ç®¡ç†ä¸è°ƒåº¦(ä¸€)</a><br><a href="https://blog.csdn.net/gatieme/article/details/51484562" target="_blank" rel="noopener">Linuxä¸‹0å·è¿›ç¨‹çš„å‰ä¸–(init_taskè¿›ç¨‹)ä»Šç”Ÿ(idleè¿›ç¨‹)â€”-Linuxè¿›ç¨‹çš„ç®¡ç†ä¸è°ƒåº¦ï¼ˆäº”ï¼‰</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/06/25/cpu/cpuæ¦‚è¿°/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="dongka">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="çŸ¥è¯†æ€»ç»“">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/25/cpu/cpuæ¦‚è¿°/" itemprop="url">CPUæ¦‚è¿°</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-06-25T00:07:09+00:00">
                2018-06-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/cpu/" itemprop="url" rel="index">
                    <span itemprop="name">cpu</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <!-- toc-aside -->
<h1><span id="cpu-topology">cpu topology</span></h1><h2><span id="11-cpuæ‹“æ‰‘">1.1. cpuæ‹“æ‰‘</span></h2><p><strong>cluster(socket)-&gt;core-&gt;Threads(ç›®å‰ä¸ºæ­¢armæ²¡æœ‰æå‡ºå¤šçº¿ç¨‹çš„æ¦‚å¿µ)</strong><br><img src="/2018/06/25/cpu/cpuæ¦‚è¿°/cpuæ‹“æ‰‘.png" alt="cpuæ‹“æ‰‘å›¾"> </p>
<h2><span id="12-å¤šæ ¸æŠ€æœ¯">1.2 å¤šæ ¸æŠ€æœ¯</span></h2><p>  åŸºäºåˆ¶ç¨‹ï¼Œæ‰©å……æ€§ç­‰è€ƒè™‘ï¼ŒèŠ¯ç‰‡å‚å•†ä¼šæŠŠå¤šä¸ªcoreå°è£…åœ¨ä¸€ä¸ªchipä¸Šï¼Œç§°ä¸ºsocketã€‚socketçš„æ¦‚å¿µåœ¨X86æ¶æ„ä¸Šä½¿ç”¨å°¤å…¶å¤šï¼Œå¯ä»¥ç†è§£ä¸ºæ’æ§½ï¼›<br>å‡è®¾ä¸€ä¸ªæ’æ§½ä¸Šæœ‰ä¸¤ä¸ªcore,é‚£ä¹ˆæˆ‘åœ¨ä¸»æ¿ä¸Šæ’2ä¸ªæ’æ§½ï¼Œå°±æ˜¯4æ ¸ç³»ç»Ÿï¼Œæ’ä¸Š4ä¸ªæ’æ§½å°±æ˜¯8æ ¸ï¼›armçš„è¯åˆ™æ˜¯å¦å¤–ä¸€ä¸ªæ¦‚å¿µcluster,ç°‡<br>  åœ¨X86æ¶æ„çš„PCä¸Šï¼Œå”¯ä¸€ç›®çš„çš„è¯æ˜¯æé«˜CPUçš„å¤„ç†æ€§èƒ½ï¼ˆä¸åœ¨ä¹åŠŸè€—ï¼‰ï¼Œä½†åœ¨ç§»åŠ¨å¸‚åœºä¸­ï¼ˆå¤§å¤šæ˜¯armï¼‰ï¼Œæ€§èƒ½æé«˜åï¼Œå¯¹åº”ç€å°±æ›´å¤šçš„poweræ¶ˆè€—ï¼›å¯¹äºè®¾å¤‡ç”µæºç®¡ç†ä»¥åŠæ•£çƒ­æå‡ºäº†æ›´é«˜çš„è¦æ±‚ã€‚ä¸æ­¤åŒæ—¶ç”µæ± å¹¶æ²¡æœ‰éšç€CPUçš„æ‹“æ‰‘çš„è¿›åŒ–è€Œè¿›åŒ–ï¼Œäºæ˜¯HMPæŠ€æœ¯å°±è¢«æå‡ºæ¥äº†ï¼›</p>
<h2><span id="13hmpheterogeneous-multi-processing">1.3HMP(Heterogeneous Multi-Processing)</span></h2><p><strong>big-little:</strong></p>
<ul>
<li>åœ¨ä¸€ä¸ªchipä¸­å°è£…ä¸¤ç±»ARM Core,ä»¥kirin 960ä¸ºä¾‹:ä¸€ç±»ä¸ºé«˜æ€§èƒ½Core,4æ ¸ARM A73ï¼Œæœ€é«˜ä¸»é¢‘ä¸º2.4Gï¼Œä¸€ç±»ä¸ºä½æ€§èƒ½Core,4æ ¸ARM A53ï¼Œæœ€é«˜ä¸»é¢‘ä¸º1.8G<br><img src="/2018/06/25/cpu/cpuæ¦‚è¿°/kirin960.png" alt="cpuæ‹“æ‰‘å›¾"></li>
</ul>
<p><strong>DynamIQ:</strong></p>
<ul>
<li>åœ¨å•ä¸€clusterå†…å¯æœ‰8ä¸ªæ ¸å¿ƒï¼Œä¸”å¯ç”±ä¸åŒæ¶æ„ï¼Œæ—¶é’Ÿçš„æ ¸å¿ƒç»„æˆï¼Œæå‡äº†è¿ä½œæ•ˆç‡ä¸é…ç½®çš„å¼¹æ€§,å¦‚é«˜é€šçš„845 4æ ¸ARM A75ï¼Œæœ€é«˜ä¸º2.8ï¼Œ4æ ¸ ARM A55ï¼Œæœ€é«˜ä¸º1.8G</li>
</ul>
<p><strong>DynamIQè¾ƒbig-littleå¥½å¤„:</strong></p>
<ol>
<li>å•clusterå¯æœ‰8æ ¸å¿ƒ</li>
<li>clusterå¯æ­é…ä¸åŒæ¶æ„çš„CPU</li>
<li>å„cpuå¯æœ‰ç‹¬ç«‹çš„è¿ä½œæ—¶é’Ÿ</li>
<li>CPUå„è‡ªå¼€å…³ä¼‘çœ äº’ä¸å½±å“</li>
<li>ä¾ç…§æ•ˆèƒ½éœ€æ±‚å¼¹æ€§è¿ç”¨å„æ ¸å¿ƒ</li>
</ol>
<p>ä»¥é¾™èˆŸæ¯”å–»ARMçš„DynamIQä¸å…ˆå‰çš„big.LITTLEæŠ€æœ¯ï¼Œæˆ‘ä»¬æŠŠé¾™èˆŸå½“æˆcluster,èˆ¹å‘˜å½“æˆcore,é‚£ä¹ˆbig.LITTLEé¾™èˆŸä¸Šåªèƒ½æœ‰4ä¸ªèˆ¹å‘˜ï¼Œè€Œä¸”æ¯ä¸ªèˆ¹å‘˜èº«æéœ€è¦ä¸€æ ·ï¼ˆæ ¸å¿ƒæ¶æ„ï¼‰ï¼Œåˆ’èˆ¹çš„æ—¶å€™è‹¥å¤šä½èˆ¹å‘˜ä¸€èµ·åˆ’èˆ¹æ—¶ï¼Œæ¯ä¸ªäººçš„å‡ºåŠ›å‡ç­‰(é¢‘ç‡ä¸€è‡´),ä¸èƒ½æœ‰äººæ…¢åˆ’æˆ–è€…å¿«åˆ’;<br>å½“ä½¿ç”¨DynamIQæ—¶ï¼Œæ¯è‰˜èˆ¹ï¼ˆclusterï¼‰ä¸Šå¯ä»¥æœ‰8ä½é«˜ä½èƒ–ç˜¦ä¸ç­‰(æ¶æ„)çš„èˆ¹å‘˜ï¼ˆcoreï¼‰ï¼Œæ¢èˆ¹é¢‘ç‡å¯ä»¥ä¸ç­‰ï¼Œä¸”èˆ¹å‘˜å¯ä»¥ä¾ç…§æŒ‡ä»¤ç¡è§‰ï¼ˆå…³é—­ï¼‰,ä¼‘æ¯ï¼ˆä¼‘çœ ï¼‰ï¼Œæˆ–åˆ’èˆ¹ï¼ˆè¿ä½œï¼‰ï¼›</p>
<h1><span id="cpuå†…æ ¸ä»£ç æ¡†æ¶">cpuå†…æ ¸ä»£ç æ¡†æ¶</span></h1><ol>
<li><a href="./cpu_init.md">ç³»ç»Ÿå¯åŠ¨æ—¶ï¼ŒCPU coreçš„åˆå§‹åŒ–ï¼Œä¿¡æ¯è·å–</a></li>
<li>ç³»ç»Ÿå¯åŠ¨æ—¶ï¼ŒCPU coreçš„å¯åŠ¨ï¼ˆenableï¼‰</li>
<li>ç³»ç»Ÿè¿è¡Œè¿‡ç¨‹ä¸­ï¼Œæ ¹æ®å½“å‰è´Ÿè·ï¼ŒåŠ¨æ€enable/disable æŸäº›CPU core,ä»¥ä¾¿åœ¨æ€§èƒ½ä¸åŠŸè€—é—´å¹³è¡¡</li>
<li>cpu coreçš„hotplugæ”¯æŒï¼Œæ‰€è°“çš„hotplug,æ˜¯å¯ä»¥åœ¨ç³»ç»Ÿè¿è¡Œçš„è¿‡ç¨‹ä¸­ï¼ŒåŠ¨æ€çš„å¢åŠ æˆ–è€…å‡å°‘CPU core(å¯ä»¥æ˜¯ç‰©ç†ä¸Šï¼Œä¹Ÿå¯ä»¥æ˜¯é€»è¾‘ä¸Š)</li>
<li>ç³»ç»Ÿè¿è¡Œè¿‡ç¨‹ä¸­CPU idleç®¡ç†</li>
<li>ç³»ç»Ÿè¿è¡Œè¿‡ç¨‹ä¸­ï¼Œæ ¹æ®å½“å‰è´Ÿè·ï¼ŒåŠ¨æ€çš„è°ƒæ•´CPU coreçš„ç”µå‹å’Œé¢‘ç‡ï¼Œä»¥ä¾¿åœ¨æ€§èƒ½å’ŒåŠŸè€—ä¹‹é—´å¹³è¡¡</li>
</ol>
<p><img src="/2018/06/25/cpu/cpuæ¦‚è¿°/cpuä»£ç æ¡†æ¶.png" alt="cpuæ‹“æ‰‘å›¾"><br>arch-depedentéƒ¨åˆ†ä½äºâ€arch\arm64\kernelâ€è´Ÿè´£å¹³å°ç›¸å…³çš„æ§åˆ¶æ“ä½œï¼ŒåŒ…æ‹¬</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cpu ä¿¡æ¯çš„è·å–ï¼ˆcpuinfoï¼‰</span><br><span class="line">cpuæ‹“æ‰‘ç»“æ„çš„è·å–ï¼ˆcpu topologyï¼‰</span><br><span class="line">åº•å±‚çš„CPUæ“ä½œï¼ˆinit,disableç­‰ï¼‰çš„å®ç°ï¼Œcpu ops</span><br><span class="line">SMPç›¸å…³çš„åˆå§‹åŒ–ï¼ˆsmpï¼‰</span><br></pre></td></tr></table></figure>
<p>arch-independentè´Ÿè´£å®ç°å¹³å°æ— å…³çš„æŠ½è±¡ï¼ŒåŒ…æ‹¬</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cpu controlæ¨¡å—ï¼Œå±è”½åº•å±‚å¹³å°ç›¸å…³å®ç°ç»†èŠ‚ï¼Œæä¾›æ§åˆ¶CPU(enable,disableç­‰)çš„ç»Ÿä¸€APIï¼Œä¾›ç³»ç»Ÿå¯åŠ¨ï¼Œè¿›ç¨‹è°ƒåº¦ç­‰æ¨¡å—è°ƒç”¨</span><br><span class="line">cpu subsystem driveråƒç”¨æˆ·ç©ºé—´æä¾›CPU hotplugæœ‰å…³çš„åŠŸèƒ½ï¼›</span><br><span class="line">cpuidle,å¤„ç†CPU idleæœ‰å…³çš„é€»è¾‘</span><br><span class="line">cpufreq å¤„ç†CPU frequencyè°ƒæ•´æœ‰å…³çš„é€»è¾‘</span><br></pre></td></tr></table></figure>
<h1><span id="cpuçš„çŠ¶æ€è¡¨ç¤º">cpuçš„çŠ¶æ€è¡¨ç¤º</span></h1><ol>
<li><strong>possible CPU:</strong> å°±æ˜¯åœ¨DTSä¸­æŒ‡å®šäº†çš„ï¼Œç‰©ç†å­˜åœ¨çš„CPU core</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">start_kernel-&gt;boot_cpu_init-&gt;smp_process_idç”¨äºè·å–cpu id</span><br><span class="line">		           -&gt;set_cpu_xxx,ç”¨äºå°†æŒ‡å®šçš„CPUè®¾ç½®ä¸ºï¼ˆæˆ–æ¸…é™¤ï¼‰æŒ‡å®šçŠ¶æ€</span><br><span class="line">	    -&gt;setup_arch-&gt;smp_init_cpus-&gt;sunxi_smp_init_cpus-&gt;set_cpu_possible(i, true)</span><br></pre></td></tr></table></figure>
<ol start="2">
<li><strong>present cpu:</strong> è¢«kernelæ ‡è¯†çš„ï¼Œå…·å¤‡æ‰§è¡Œä»£ç æ¡ä»¶ï¼Œåç»­å¯ä»¥åœ¨éœ€è¦çš„æ—¶å€™ï¼ˆå¦‚hotplugçš„æ—¶å€™ï¼‰ï¼Œå¯åŠ¨è¯¥CPU </li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">start_kernel-&gt;rest_init-&gt;kernel_init-&gt;kernel_init_freeable</span><br><span class="line">				     -&gt;smp_prepare_cpus</span><br><span class="line">			     	if (cpu_prepare(cpu)) /**/</span><br><span class="line">					set_cpu_present(cpu,true);</span><br></pre></td></tr></table></figure>
<ol start="3">
<li><strong>online CPU:</strong> æŸä¸ªCPUæ˜¯presentçš„ï¼Œä¸ä¸€å®šæ˜¯boot,æ‰€è°“CPU boot,å°±æ˜¯è®©CPUæ‰§è¡Œï¼ˆå–æŒ‡è¯‘ç /æ‰§è¡Œï¼‰ä»£ç </li>
<li><strong>active CPU</strong> åªæ˜¯ä¸ºäº†æ–¹ä¾¿è°ƒåº¦å™¨æ“ä½œ</li>
</ol>
<h1><span id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</span></h1><p><a href="https://www.cool3c.com/article/124149" target="_blank" rel="noopener">ä¸€å›¾çœ‹æ‡‚ARM DynamIQè¿ä½œåŸç†</a><br><a href="http://www.wowotech.net/pm_subsystem/cpu_core_pm_overview.html" target="_blank" rel="noopener">Linux CPU coreçš„ç”µæºç®¡ç†(1)æ¦‚è¿°</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/06/25/thermal/thermal_framework/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="dongka">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="çŸ¥è¯†æ€»ç»“">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/25/thermal/thermal_framework/" itemprop="url">Thermal æ¡†æ¶æ¢³ç†</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-06-25T00:07:09+00:00">
                2018-06-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/thermal/" itemprop="url" rel="index">
                    <span itemprop="name">thermal</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1><span id="theramlæ¡†æ¶æ¡†å›¾">theramlæ¡†æ¶æ¡†å›¾</span></h1><ol>
<li>thermal_zone_deviceï¼šè·å–æ¸©åº¦è®¾å¤‡çš„æŠ½è±¡</li>
<li>thermal_cooling_device: é™ä½æ¸©åº¦æªæ–½çš„æŠ½è±¡</li>
<li>thermal_governor:æ¸©æ§ç­–ç•¥ï¼Œstep wise, bangbang,user space,power_allocatorï¼Œfair_share</li>
<li>thermal_core : ä½œä¸ºuser spaceå’Œkernelçš„æ¥å£ï¼ŒåŒæ—¶ä¹Ÿæ˜¯Thermalæ¡†æ¶çš„ä¸­æ¢</li>
</ol>
<p>ç›¸å…³çš„èŠ‚ç‚¹ï¼š/sys/class/thermal<br><img src="/2018/06/25/thermal/thermal_framework/thermal.jpg" alt="thermal"></p>
<h1><span id="thermal_zone_device">thermal_zone_device</span></h1><pre><code>dts
    cpu_thermal_zone{

                            polling-delay-passive = &lt;1000&gt;;
                            polling-delay = &lt;2000&gt;;
                            thermal-sensors = &lt;&amp;ths_combine0 0&gt;;

                            trips{
                                    cpu_trip0:t0{
                                            temperature = &lt;65&gt;;
                                            type = &quot;passive&quot;;
                                            hysteresis = &lt;0&gt;; 
                                    };   
                                    cpu_trip1:t1{
                                            temperature = &lt;75&gt;;
                                            type = &quot;passive&quot;;
                                            hysteresis = &lt;0&gt;; 
                                    };   
    ....

struct thermal_zone_of_device_ops {
    int (*get_temp)(void *, int *);  
    int (*get_trend)(void *, int, enum thermal_trend *); 
    int (*set_trips)(void *, int, int); // è®¾ç½®æ¸©åº¦çª—å£ï¼Œå½“æ¸©åº¦è¶…è¿‡è®¾ç½®ç‚¹éœ€è¦é€šè¿‡thermal_zone_device_update
    int (*set_emul_temp)(void *, int);
    int (*set_trip_temp)(void *, int, int);
};

struct thermal_zone_of_device_ops combine_ops = { 
    .get_temp          = sunxi_combine_get_temp,
    .set_emul_temp     = sunxi_combine_set_emul_temp,

};

åœ¨probeä¸­å®Œæˆæ³¨å†Œï¼š
sensor-&gt;tz = thermal_zone_of_sensor_register(&amp;pdev-&gt;dev,
        id, sensor, &amp;combine_ops);

æ¸©åº¦è·å–æµç¨‹

sunxi_combine_get_temp //sunxi_ths_combine.c
    --&gt;ret = controller-&gt;ops-&gt;get_temp(controller,sensor_id, &amp;temp);
sunxi_ths_get_temp  // sunxi_ths_core.c
    --&gt;t = ths_driver_get_temp(ths_data, id);
ths_driver_reg_to_temp(reg_data, id, ths_data-&gt;ths_driver_version, ths_data-&gt;ths_coefficent-&gt;calcular_para); //sunxi_ths_driver.c
</code></pre><h1><span id="thermal_core">thermal_core</span></h1><p> åœ¨thermar coreä½œä¸ºä¸­æ¢æ³¨å†Œgovernor,æ³¨å†ŒThermalç±»ï¼Œå¹¶ä¸”åŸºäºDevice Treeæ³¨å†ŒThermal Zoneï¼›æä¾›Thermal zoneæ³¨å†Œå‡½æ•°ï¼ŒCooling Deviceæ³¨å†Œå‡½æ•°ï¼Œæä¾›å°†Coolingè®¾å¤‡ç»‘å®šåˆ°Zoneçš„å‡½æ•°ï¼Œä¸€ä¸ªThermal Zoneå¯ä»¥æœ‰å¤šä¸ªCoolingè®¾å¤‡ï¼›åŒæ—¶è¿˜æä¾›ä¸€ä¸ªæ ¸å¿ƒå‡½æ•°Thermal_\zone_device\updateä½œä¸ºThermalä¸­æ–­å¤„ç†å‡½æ•°å’Œè½®è¯¢å‡½æ•°ï¼Œè½®è¯¢æ—¶é—´ä¼šæ ¹æ®ä¸åŒTrip Delayè°ƒèŠ‚</p>
<h2><span id="1thermal_init">1.thermal_init</span></h2><p><img src="/2018/06/25/thermal/thermal_framework/thermal_init.png" alt="thermal_init"></p>
<h2><span id="2netlink">2.netlink</span></h2><p>  <strong>netlinkæ˜¯linuxæä¾›çš„ç”¨äºå†…æ ¸å’Œç”¨æˆ·æ€è¿›ç¨‹ä¹‹é—´é€šä¿¡çš„æ–¹å¼ã€‚</strong>ä¸€èˆ¬æ¥è¯´ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´çš„é€šä¿¡æ–¹å¼æœ‰ä¸‰ç§ï¼š/proc,ioctl,netlink,è€Œå‰ä¸¤ç§æ˜¯å•å‘çš„ï¼Œä½†æ˜¯netlinkå¯ä»¥å®ç°åŒå·¥é€šä¿¡ï¼›è™½ç„¶netlinkä¸»è¦ç”¨äºç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´çš„é€šä¿¡ï¼Œä½†æ˜¯ä¹Ÿèƒ½ç”¨äºç”¨æˆ·ç©ºé—´çš„ä¸¤ä¸ªè¿›ç¨‹é€šä¿¡ã€‚åªæ˜¯è¿›ç¨‹é—´é€šä¿¡æœ‰å…¶ä»–å¾ˆå¤šæ–¹å¼ï¼Œé™¤ééœ€è¦ç”¨åˆ°netlinkçš„å¹¿æ’­ç‰¹æ€§ï¼›</p>
<p>  <strong>netlinkæœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š</strong></p>
<p>  1.æ”¯æŒå…¨åŒå·¥ï¼Œå¼‚æ­¥é€šä¿¡ï¼ˆå½“ç„¶ä¹ŸåŒæ­¥ä¹Ÿæ”¯æŒï¼‰</p>
<p>  2.ç”¨æˆ·ç©ºé—´å¯ä½¿ç”¨æ ‡å‡†çš„BSD socketæ¥å£</p>
<p>  3.åœ¨å†…æ ¸ç©ºé—´ä½¿ç”¨ä¸“é—¨çš„å†…æ ¸APIæ¥å£</p>
<p>  4.æ”¯æŒå¤šæ’­ï¼ˆå› æ­¤æ”¯æŒâ€æ€»çº¿â€å¼é€šä¿¡ï¼Œå¯å®ç°æ¶ˆæ¯è®¢é˜…ï¼‰</p>
<p>  5.åœ¨å†…æ ¸ç«¯å¯ç”¨äºè¿›ç¨‹ä¸Šä¸‹æ–‡å’Œä¸­æ–­ä¸Šä¸‹æ–‡ï¼›</p>
<p> <strong>ç”¨æˆ·æ€ä½¿ç”¨netlinkï¼š</strong></p>
<p> ç”¨æˆ·æ€åº”ä½¿ç”¨æ ‡å‡†çš„socket APIs,socket(),bind(),sendmsg(),recvmsg()å’Œclose()å°±å¯ä»¥ä½¿ç”¨netlink socket</p>
<p> <strong>netlinkå†…æ ¸API</strong> </p>
<p> ä¸€ï¼šå®šä¹‰åè®®ç±»å‹ ï¼ˆå¯çœç•¥ï¼‰</p>
<p> äºŒï¼šnetlink_kernel_create</p>
<p> ä¸‰ï¼šè®¾ç½®ç›®æ ‡åœ°å€ä¸æºåœ°å€</p>
<p> å››ï¼šé€šè¿‡netlink_unicastå’Œnetlink_broadcastå‘é€æ¶ˆæ¯ï¼›</p>
<h2><span id="3thermalè½®è¯¢æµç¨‹">3.thermalè½®è¯¢æµç¨‹</span></h2><p>åœ¨thermal coreä¸­é€šè¿‡ä¸æ–­çš„è½®è¯¢æ¥æ£€æµ‹æ¸©åº¦å˜åŒ–ï¼Œå¦‚æœæ¸©åº¦æ²¡æœ‰è¾¾åˆ°critalåˆ™è°ƒç”¨governorçš„throttleï¼Œé€šè¿‡governorçš„throttleå†³å®šä¸‹ä¸€æ¬¡è½®è¯¢çš„æ—¶é—´ï¼›å¦‚æœæ¸©åº¦ä¸ºcritalåˆ™èµ°å…³æœºæµç¨‹ï¼›</p>
<p><img src="/2018/06/25/thermal/thermal_framework/thermal_core.jpg" alt="thermal_coreè°ƒç”¨æµç¨‹"></p>
<h1><span id="cooling_device">cooling_device</span></h1><p>åµŒå…¥å¼è®¾å¤‡é€šè¿‡æ”¹å˜é¢‘ç‡ç”µå‹ï¼Œæ¥è¾¾åˆ°æ”¹å˜åŠŸè€—çš„ç›®çš„ï¼Œcooling_deviceæä¾›äº†è·å–å½“å‰è®¾å¤‡çš„æ¸©æ§çŠ¶æ€ä»¥åŠè®¾ç½®ç­‰æ¥å£ï¼›<br><img src="/2018/06/25/thermal/thermal_framework/cooling_device.png" alt="cooling_device"></p>
<h2><span id="thermal_cooling_device">thermal_cooling_device</span></h2><pre><code>dts:
cooling-maps{
                                    bind0{
                                            contribution = &lt;0&gt;;
                                            trip = &lt;&amp;cpu_trip0&gt;;
                                            cooling-device
                                            = &lt;&amp;cpu_budget_cooling 1 1&gt;;
                                    };
                                    bind1{
                                            contribution = &lt;0&gt;;
                                            trip = &lt;&amp;cpu_trip1&gt;;
                                            cooling-device
                                            = &lt;&amp;cpu_budget_cooling 2 2&gt;;
                                    };
...
               cpu_budget_cooling:cpu_budget_cool{
                    compatible = &quot;allwinner,budget_cooling&quot;;
                    device_type = &quot;cpu_budget_cooling&quot;;
                    #cooling-cells = &lt;2&gt;;
                    status = &quot;okay&quot;;
                    state_cnt = &lt;7&gt;;
                    cluster_num = &lt;1&gt;;
                    state0 = &lt;1800000 4&gt;;
                    state1 = &lt;1512000 4&gt;;
                    state2 = &lt;1416000 4&gt;;
                    state3 = &lt;1200000 4&gt;;
                    state4 = &lt;1008000 3&gt;;
                    state5 = &lt;1008000 2&gt;;
                    state6 = &lt;1008000 1&gt;;
            };
...


struct thermal_cooling_device_ops {
    int (*get_max_state) (struct thermal_cooling_device *, unsigned long *);   //è·å–æœ€é«˜çš„coolingçŠ¶æ€çš„å›è°ƒå‡½æ•°ï¼ŒæŒ‡æœ€ä½åŠŸè€—çš„OPP                       
    int (*get_cur_state) (struct thermal_cooling_device *, unsigned long *); //è·å–å½“å‰coolingçŠ¶æ€çš„å›è°ƒå‡½æ•°                          
    int (*set_cur_state) (struct thermal_cooling_device *, unsigned long);   //æ ¹æ®cooling_stateæ‰§è¡Œcpufreqçš„å›è°ƒå‡½æ•°ï¼Œæ˜¯æ‰§è¡Œçš„å®ä½“                         
    int (*get_requested_power)(struct thermal_cooling_device *,
                               struct thermal_zone_device *, u32 *);//è·å–å½“å‰å½“å‰CPUçš„åŠŸè€—å€¼ï¼ŒåŒ…æ‹¬dynamicåŠŸè€—å’ŒstaticåŠŸè€—ã€‚ä¸­é—´éœ€è¦ç”¨åˆ°dyn_power_tableè¿›è¡Œè½¬æ¢                                  
    int (*state2power)(struct thermal_cooling_device *,
                       struct thermal_zone_device *, unsigned long, u32 *); //å°†CPU coolingçŠ¶æ€è½¬æ¢æˆéœ€è¦æ¶ˆè€—çš„åŠŸè€—å€¼ï¼›                          
    int (*power2state)(struct thermal_cooling_device *,
                       struct thermal_zone_device *, u32, unsigned long *);//å°†CPUæ‰€èƒ½è·å–çš„æœ€å¤§åŠŸè€—å€¼è½¬æ¢æˆcoolingçŠ¶æ€                           
};

static struct thermal_cooling_device_ops const sunxi_cpu_cooling_ops = {
    .get_max_state = cpu_budget_get_max_state,
    .get_cur_state = cpu_budget_get_cur_state,
    .set_cur_state = cpu_budget_set_cur_state,
};
cool_dev = thermal_of_cooling_device_register(
                        pdev-&gt;dev.of_node,
                        SUNXI_BUDGET_COOLING_NAME,
                        budget_cdev,
                        &amp;sunxi_cpu_cooling_ops);

set_cur_state
    -&gt;cpu_budget_apply_cooling(cooling_device, state); 
        -&gt;sunxi_hotplug_update_state(cooling_device, cluster);
            -&gt;autohotplug_roomage_limit(cluster, min, max); //é™åˆ¶æœ€å¤§çš„æ ¸æ•°
        -&gt;sunxi_cpufreq_update_state(cooling_device, cluster);  ??æ€ä¹ˆä¼ é€’è¿™ä¸ªå‚æ•°çš„
            -&gt;cpufreq_update_policy(cpuid); //é™åˆ¶æœ€å¤§é¢‘ç‡
</code></pre><h1><span id="thermal-governor">thermal governor</span></h1><h2><span id="å†…æ ¸ä¸­çš„governorç­–ç•¥">å†…æ ¸ä¸­çš„governorç­–ç•¥</span></h2><p><strong>step wise</strong>: Open loop control. Temperature threshold and trend based. Walk through each cooling device cooling state, step by step.</p>
<p><strong>fair share</strong>: Weight based. Determine the cooling device state based on assigned weight partitioning.</p>
<p><strong>bang bang</strong>: uses a hysteresis to switch abruptly on or off a cooling device. It is intended to control fans, which can not be throttled but just switched on or off.</p>
<p><strong>power allocator</strong>: Closed loop control. Based on power budget, temperature, and current power consumption of each involved device.</p>
<p><strong>user space</strong>: hand off the control of a thermal zone to user space. Example: thermald and iTux.</p>
<h2><span id="æ‰‹æœºç«¯çš„thermalé…ç½®æƒ…å†µ">æ‰‹æœºç«¯çš„thermalé…ç½®æƒ…å†µ</span></h2><h3><span id="mtk">mtk</span></h3><p>ä»¥é­…æ— 15plusä¸ºä¾‹</p>
<pre><code>15Plus:/sys/class/thermal $ ls
cooling_device0 cooling_device2 cooling_device4 cooling_device6 thermal_zone1 thermal_zone3 thermal_zone5\
cooling_device1 cooling_device3 cooling_device5 thermal_zone0   thermal_zone2 thermal_zone4
</code></pre><p>cooling device</p>
<pre><code>15Plus:/sys/class/thermal/cooling_device1 $ ls
cur_state max_state power subsystem type uevent
for i in $(seq 0 6)
do
    printf &quot;cooling_device$i\t&quot;
    type=$(cat cooling_device$i/type)
    printf &quot;$type\t&quot;
    cur_state=$(cat cooling_device$i/cur_state)
    printf &quot;$cur_state\t&quot;
    max_state=$(cat cooling_device$i/max_state)
    printf &quot;$max_state\n&quot;
done
cooling_device0         battery_control02       0       1
cooling_device1         battery_control01       0       1
cooling_device2         battery_control00       0       1
cooling_device3         thermal-cpufreq-0       0       13
cooling_device4         thermal-cpufreq-1       0       8
cooling_device5         thermal-gpufreq-0       0       4
cooling_device6         thermal-isp-0           0       2
</code></pre><p>thermal_zone</p>
<pre><code>for i in $(seq 0 5)
do
    printf &quot;thermal_zone$i\t&quot;
    type=$(cat thermal_zone$i/type)
    printf &quot;$type\t&quot;
    policy=$(cat thermal_zone$i/policy)
    printf &quot;$policy\n&quot;
done

thermal_zone0   mngs-thermal    power_allocator        cdevã€0-1ã€‘ -&gt; ../cooling_device3        thermal-cpufreq-0
thermal_zone1   APOLLO          step_wise            cdevã€0-4ã€‘ -&gt; ../cooling_device4        thermal-cpufreq-1
thermal_zone2   GPU             power_allocator     cdevã€0-1ã€‘ -&gt; ../cooling_device5        thermal-gpufreq-0
thermal_zone3   ISP             step_wise             cdevã€0-4ã€‘ -&gt; ../cooling_device6        thermal-isp-0
thermal_zone4   battery         step_wise
thermal_zone5   meizu_ntc       step_wise             cdevã€0-2ã€‘ -&gt; ../cooling_deviceã€0-2ã€‘    battery_control0ã€0-2ã€‘
</code></pre><h3><span id="æµ·æ€">æµ·æ€</span></h3><p>ä»¥è£è€€9ä¸ºä¾‹</p>
<p>cooling_device</p>
<pre><code>cooling_device0 thermal-devfreq-0       05
cooling_device1 thermal-cpufreq-0       04
cooling_device2 thermal-cpufreq-1       04
</code></pre><p>thermal_zone</p>
<pre><code>thermal_zone0   soc_thermal     power_allocator  cdevã€0-2ã€‘ -&gt; ../cooling_device[0-2]
thermal_zone1   Battery         user_space
thermal_zone2   cluster0        user_space    
thermal_zone3   cluster1        user_space
thermal_zone4   gpu                user_space
thermal_zone5   modem           user_space
thermal_zone6   ddr                user_space
thermal_zone7   system_h        user_space
thermal_zone8   flash_led       user_space
thermal_zone9   charger         user_space
thermal_zone10  pa_0            user_space
thermal_zone11  dcxo0           user_space
thermal_zone12  hisi_shell      user_space
thermal_zone13  hisi_ambient    user_space
</code></pre><h3><span id="é«˜é€š">é«˜é€š</span></h3><p>ä»¥pixelä¸ºä¾‹</p>
<p>cooling_device</p>
<pre><code>                    type                cur_state    max_state
cooling_device0 thermal-cpufreq-0       1900800         21
cooling_device1 thermal-cpufreq-1       2457600            30
</code></pre><p>thermal_zone </p>
<pre><code>thermal_zone0   mnh_ipu1                step_wise
thermal_zone1   mnh_ipu2                   step_wise
thermal_zone2   mnh_cpu                 step_wise
thermal_zone3   mnh_lpddr                   step_wise
thermal_zone4   usb                     step_wise
thermal_zone5   battery                 step_wise
thermal_zone6   usb_port_temp           step_wise
thermal_zone7   pm8998_tz               step_wise
thermal_zone8   pmi8998_tz              step_wise
thermal_zone9   pm8005_tz               step_wise
thermal_zone10  msm_therm                   step_wise
thermal_zone11  quiet_therm             step_wise
thermal_zone12  xo_therm                step_wise
thermal_zone13  fpc_therm               step_wise
thermal_zone14  back_therm              step_wise
thermal_zone15  pa_therm                step_wise
thermal_zone16  tsens_tz_sensor0        step_wise
thermal_zone17  tsens_tz_sensor1        step_wise
thermal_zone18  tsens_tz_sensor2        step_wise
thermal_zone19  tsens_tz_sensor3        step_wise
thermal_zone20  tsens_tz_sensor4        step_wise
thermal_zone21  tsens_tz_sensor7        step_wise
thermal_zone22  tsens_tz_sensor8        step_wise
thermal_zone23  tsens_tz_sensor9        step_wise
thermal_zone24  tsens_tz_sensor10       step_wise
thermal_zone25  tsens_tz_sensor11       step_wise
thermal_zone26  tsens_tz_sensor12       step_wise
thermal_zone27  tsens_tz_sensor13       step_wise
thermal_zone28  tsens_tz_sensor14       step_wise
thermal_zone29  tsens_tz_sensor15       step_wise
thermal_zone30  tsens_tz_sensor16       step_wise
thermal_zone31  tsens_tz_sensor17       step_wise
thermal_zone32  tsens_tz_sensor18       step_wise
thermal_zone33  tsens_tz_sensor19       step_wise
thermal_zone34  tsens_tz_sensor20       step_wise
thermal_zone35  tsens_tz_sensor21       step_wise
thermal_zone36  limits_sensor-00        step_wise
thermal_zone37  limits_sensor-01        step_wise
thermal_zone38  bcm15602_tz             step_wise
thermal_zone39  bms                     step_wise
thermal_zone40  GLM_soc                 step_wise
</code></pre><p>é€šè¿‡è§‚å¯Ÿå‘ç°ï¼Œpower allocatorï¼Œstep wise,user spaceä¸ºå¸¸ç”¨çš„governorï¼Œæ•…ä»¥ä¸‹ç®€å•ä»‹ç»æ­¤ä¸‰ç§thermal;</p>
<h2><span id="power-allocator">Power allocator</span></h2><h3><span id="ipaçš„å‘å±•å†å²">IPAçš„å‘å±•å†å²</span></h3><pre><code>åœ¨2013ï¼ŒARM å¼€å§‹åœ¨Linux OSä¸­å¸ƒå±€IPAï¼Œåªæ˜¯ä»‹ç»äº†ç›¸å…³çš„æ¦‚å¿µå’Œåœ¨å®é™…åœºæ™¯ä¸­çš„å¥½å¤„ï¼›
åœ¨2015å¹´3æœˆ3å·ï¼Œç¬¬ä¸€ä¸ªå®Œæ•´çš„IPAæäº¤è¢«çº³å…¥Linux,å¹¶è¢«mergeåˆ°linux4.2.æ‰€ä»¥linux4.2ä¹‹åä¸ç”¨å†æ‰“ç›¸å…³çš„pactch
</code></pre><p>åœ¨è®²power allocator å‰ï¼Œéœ€è¦å…ˆè®²ä¸ªæ¦‚å¿µPIDï¼ˆProportional Integral Derivativeï¼‰çš„æ¦‚å¿µ;</p>
<h3><span id="pidæ§åˆ¶å™¨">PIDæ§åˆ¶å™¨</span></h3><p><img src="/2018/06/25/thermal/thermal_framework/pid.png" alt="pid"></p>
<p>PIDæ§åˆ¶å™¨æ˜¯ä¸€ä¸ªé—­ç¯çš„ç³»ç»Ÿï¼Œé€šè¿‡å°†è¾“å‡ºåé¦ˆåˆ°è¾“å…¥ï¼Œè¿™ä½¿ç³»ç»Ÿå¯ä»¥å¾—åˆ°æ›´ç²¾ç»†å’Œè‡ªé€‚åº”çš„æ§åˆ¶</p>
<p>.u(t) is the control signal.</p>
<p>.y(t)is the actual output value.</p>
<p>.r(t) is the reference value, also called the setpoint. It is the desired output value.</p>
<p>.e(t) is the control error (e(t) = r(t) âˆ’ y(t)). It shows the difference between the reference value and the actual output value.</p>
<p>.The term Plant refers to the object that is being controlled<br>The control signal ğ‘¢(ğ‘¡) is a sum of the following terms:</p>
<pre><code>The P-term: This term is proportional to the error. It acts on the present value of the error.
The I-term: This term is proportional to the integral of the error. It represents the accumulation of past errors.
The D-term: This term is proportional to the derivative of the error. It can be interpreted as a prediction of future errors, based on linear extrapolation according to the current rate of change.
</code></pre><p>PIDæ§åˆ¶å™¨é€‚ç”¨äºå¤šä¸ªæ§åˆ¶é¢†åŸŸï¼Œé™¤äº†å¤šè·¯è¾“å…¥è¾“å‡ºï¼›</p>
<p>å¯¹äºthermal è€Œè¨€ï¼Œå¯¹åº”çš„PIDå¦‚ä»¥ä¸‹æ¨¡æ ·ï¼š</p>
<p><img src="/2018/06/25/thermal/thermal_framework/thermal_pid.png" alt="thermal_pid"></p>
<p><em>Pmax</em> æ˜¯æ ¹æ®å½“å‰çš„æ¸©åº¦å’Œé¢„æƒ³çš„æ¸©åº¦è®¡ç®—å‡ºæ¥çš„ç³»ç»Ÿå¯ä»¥è¿è¡Œçš„æœ€å¤§åŠŸè€—ï¼š</p>
<p><strong>è®¡ç®—å…¬å¼å¦‚ä¸‹ï¼š</strong></p>
<pre><code>P_max = k_p * e + k_i * err_integral + k_d * diff_err + sustainable_power
e = desired_temperature - current_temperature
err_integral is the sum of previous errors
diff_err = e - previous_error
</code></pre><p>. æ‰€è°“çš„Sustainable Poweræ˜¯åœ¨ä¸åŒOPPæƒ…å¢ƒä¸‹ï¼ŒæŸä¸€ä¸ªæœ€å¤§çš„OPPçš„æ¸©åº¦ä¿æŒåŸºæœ¬ç¨³å®šï¼Œæ¯”å…¶å¤§è€…ï¼Œæ¸©åº¦ä¸Šå‡æ˜æ˜¾ï¼›æ¯”å…¶å°è€…æ¸©åº¦ä¿æŒä¸å˜æˆ–è€…ä¸‹é™ï¼›è¿™å¯ä»¥é€šè¿‡ç›‘æµ‹ä¸åŒOPPå¯¹åº”çš„æ¸©åº¦å€¼ï¼Œå¾—åˆ°ä¸€ä¸ªSustainable Power</p>
<pre><code>ä»¥è£è€€9ä¸ºä¾‹: 
Sustainable Power = 4500
trip_point_1_temp = 80000;
trip_point0_temp = 55000;
if (!tz-&gt;tzp-&gt;k_po || force)
    tz-&gt;tzp-&gt;k_po = int_to_frac(sustainable_power) / temperature_threshold;
k_po = sustainable_power / (desired_temperature - switch_on_temp) = ï¼ˆ4500 * 1024ï¼‰/(80000-55000) = 184.32
if (!tz-&gt;tzp-&gt;k_pu || force)
     tz-&gt;tzp-&gt;k_pu = int_to_frac(2 * sustainable_power) / temperature_threshold 
k_pu = 2 * sustainable_power / (desired_temperature - switch_on_temp) = = (2 * 4500 * 1024)/(80000 - 55000) =  368.64;
tz-&gt;tzp-&gt;k_i = int_to_frac(10) / 1000 = 10.24;
k_i = 10 * 1024 /1000 = ä¸ºç§¯åˆ†å¸¸æ•°ï¼Œç”¨æ¥è¡¥å¿åç§»ï¼›å½“æ¸©åº¦è¯¯å·®ä½äº integral_cutoffï¼ˆä¸€èˆ¬ä¸º0ï¼‰è¯¯å·®å°±ä¼šè¢«ç´¯è®¡
k_d ä¸ºæ±‚å¯¼ï¼Œä¸€èˆ¬è®¾ç½®ä¸º0
</code></pre><p><img src="/2018/06/25/thermal/thermal_framework/power_allocate_throttle.jpg" alt="power_allocate_throttle"></p>
<h2><span id="step-wise">step wise</span></h2><p>æ ¹æ®å½“å‰æ¸©åº¦çš„è¶‹åŠ¿ï¼ˆä¸Šå‡ï¼Œä¸‹é™ï¼‰å’Œä¸å½“å‰çš„tripæ¸©åº¦å¯¹æ¯”ï¼Œæ¥å†³å®šCPUä¸‹ä¸€æ¬¡çš„coolingçŠ¶æ€</p>
<p><img src="/2018/06/25/thermal/thermal_framework/step_wise.jpg" alt="step_wise"></p>
<h2><span id="user-space">user space</span></h2><p>é€šè¿‡å°†æ¸©åº¦ï¼Œäº‹ä»¶ï¼Œæš´éœ²åˆ°ä¸Šå±‚ï¼Œä¸Šå±‚åº”ç”¨å†å»é©±åŠ¨throttleè¿›è¡Œæ§æ¸©ï¼Œç›®å‰æ²¡æœ‰ç›¸å…³çš„èµ„æ–™å¯ä»¥åˆ†æï¼Œæš‚æ—¶ä¸åšåˆ†æï¼›</p>
<h1><span id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</span></h1><p><a href="https://www.cnblogs.com/arnoldlu/p/6388151.html" target="_blank" rel="noopener">Android/Linux Thermalæ¡†æ¶åˆ†æåŠå…¶Governorå¯¹æ¯”</a></p>
<p><a href="https://www.cnblogs.com/arnoldlu/p/6388112.html" target="_blank" rel="noopener">Android/Linux Thermal Governorä¹‹IPAåˆ†æä¸ä½¿ç”¨</a></p>
<p><a href="http://blog.jobbole.com/104334/" target="_blank" rel="noopener">LinuxNetlinkåŸºæœ¬ä½¿ç”¨</a></p>
<p><a href="https://www.ibm.com/developerworks/cn/linux/l-kerns-usrs/index.html" target="_blank" rel="noopener">å†…æ ¸å¯åŠ¨å‚æ•°ï¼Œæ¨¡å—å‚æ•°ä¸sysfs,sysctl,ç³»ç»Ÿè°ƒç”¨å’Œnetlink</a></p>
<p><a href="https://www.techbang.com/posts/17396-power-states-know-how-many-g-p-t-s-c-read" target="_blank" rel="noopener">ç”µè„‘å¾…æœºï¼Œç¡çœ ï¼Œä¼‘çœ åˆ†ä¸æ¸…æ¥šï¼ŸP,T,S,G,Cç”µæºçŠ¶æ€ä¸€æ¬¡çœ‹æ‡‚</a></p>
<p><a href="file:///C:/Users/key/Downloads/thermal-framework-status-no-transitioning.pdf" target="_blank" rel="noopener">The thermal framework</a></p>
<p><a href="http://infocenter.arm.com/help/topic/com.arm.doc.dto0052a/DTO0052A_intelligent_power_allocation_white_paper.pdf" target="_blank" rel="noopener">intelligent_power_allocation_white_paper</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/06/25/tools/ds5-userguide/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="dongka">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="çŸ¥è¯†æ€»ç»“">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/25/tools/ds5-userguide/" itemprop="url">DS5ç›¸å…³ä»‹ç»</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-06-25T00:07:09+00:00">
                2018-06-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/å·¥å…·ä½¿ç”¨/" itemprop="url" rel="index">
                    <span itemprop="name">å·¥å…·ä½¿ç”¨</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <!-- toc -->
<ul>
<li><a href="#ä¸€-ds5-ä¸-dstream">ä¸€. DS5 ä¸ DSTREAM</a><ul>
<li><a href="#1-ds5-æ˜¯ä¸€ä¸ªè½¯ä»¶å¼€å‘å·¥å…·">1. DS5 æ˜¯ä¸€ä¸ªè½¯ä»¶å¼€å‘å·¥å…·</a></li>
<li><a href="#2-dstream-æ˜¯ä¸€ä¸ªç¡¬ä»¶ä»¿çœŸå·¥å…·">2. DSTREAM æ˜¯ä¸€ä¸ªç¡¬ä»¶ä»¿çœŸå·¥å…·</a></li>
</ul>
</li>
<li><a href="#äºŒ-å®‰è£…ds5">äºŒ. å®‰è£…DS5</a></li>
<li><a href="#ä¸‰-ds5çš„ä½¿ç”¨">ä¸‰. DS5çš„ä½¿ç”¨</a><ul>
<li><a href="#1æ–°å»ºdebug-control">1.æ–°å»ºdebug control</a></li>
<li><a href="#2å»ºç«‹è¿æ¥">2.å»ºç«‹è¿æ¥</a></li>
<li><a href="#3load-vmlinux">3.load vmlinux</a></li>
<li><a href="#4æŸ¥çœ‹logbuf">4.æŸ¥çœ‹logbuf</a></li>
<li><a href="#5load-æºç å•æ­¥è°ƒè¯•">5.load æºç å•æ­¥è°ƒè¯•</a></li>
</ul>
</li>
<li><a href="#å››csatçš„ä½¿ç”¨">å››ï¼šcsatçš„ä½¿ç”¨</a><ul>
<li><a href="#1castcoresight-access-toolcsat">1.cast:CoreSight Access Tool(CSAT)</a></li>
<li><a href="#2csat-ds-5-diff">2.CSAT &amp; DS-5 diff</a></li>
<li><a href="#3csatçš„å‘½ä»¤">3.CSATçš„å‘½ä»¤</a></li>
</ul>
</li>
</ul>
<!-- tocstop -->
<h1><span id="ä¸€-ds5-ä¸-dstream">ä¸€. DS5 ä¸ DSTREAM</span></h1><h2><span id="1-ds5-æ˜¯ä¸€ä¸ªè½¯ä»¶å¼€å‘å·¥å…·">1. DS5 æ˜¯ä¸€ä¸ªè½¯ä»¶å¼€å‘å·¥å…·</span></h2><p><img src="/2018/06/25/tools/ds5-userguide/ds5/ds5.png" alt="ds5"><br>  ä»ä»¥ä¸‹å·¥å…·å‘å±•è€Œæ¥ï¼šDS5&lt;RVDS&lt;ADS&lt;SDT,ç›®å‰é™¤DS5å¤–å…¶ä»–éƒ½å·²åœç”¨ï¼›<br>  æœ‰å›¾å½¢åŒ–çš„streamlineæ€§èƒ½åˆ†æå™¨ï¼Œå¯åŸºäºCæºç ï¼Œæ±‡ç¼–ç¨‹åºï¼Œåœ°å€å¯¹bareè£¸æœºç¨‹åºï¼Œuboot,kernel,é©±åŠ¨ï¼Œappè¿›è¡Œçƒ­ç‚¹ï¼Œç¨‹åºç“¶é¢ˆï¼ŒCPUä½¿ç”¨ï¼ŒCache hit/miss,åŠŸè€—åˆ†æ</p>
<h2><span id="2-dstream-æ˜¯ä¸€ä¸ªç¡¬ä»¶ä»¿çœŸå·¥å…·">2. DSTREAM æ˜¯ä¸€ä¸ªç¡¬ä»¶ä»¿çœŸå·¥å…·</span></h2><p><img src="/2018/06/25/tools/ds5-userguide/ds5/dstream.png" alt="dstream"><br>    å…±æœ‰7ä¸ªæ¥å£ï¼Œå…¶ä¸­ARM JTAG 14ï¼ŒTI JTAG 14ï¼ŒARM JTAG 20å’ŒCoresight 10è¿™4ä¸ªæ¥å£ä»…æœ‰debugåŠŸèƒ½ï¼ŒåŒæ—¶MICTOR 38ï¼ŒMIPI34ï¼ŒCoresight 20è¿™3ä¸ªæ¥å£æœ‰debug+traceåŠŸèƒ½</p>
<h1><span id="äºŒ-å®‰è£…ds5">äºŒ. å®‰è£…DS5</span></h1><ol>
<li>å®‰è£…è™šæ‹Ÿç½‘å¡ï¼›</li>
<li>å®‰è£…DS5-19å’Œå®Œæˆlicenceæ³¨å†Œ</li>
<li>æ‹·è´æ¨¡å‹åˆ°å®‰è£…ç›®å½•ä¸‹</li>
<li>æ‰“å¼€DS5</li>
</ol>
<h1><span id="ä¸‰-ds5çš„ä½¿ç”¨">ä¸‰. DS5çš„ä½¿ç”¨</span></h1><h2><span id="1æ–°å»ºdebug-control">1.æ–°å»ºdebug control</span></h2><p><img src="/2018/06/25/tools/ds5-userguide/ds5/use1.png" alt="use1"></p>
<h2><span id="2å»ºç«‹è¿æ¥">2.å»ºç«‹è¿æ¥</span></h2><p><img src="/2018/06/25/tools/ds5-userguide/ds5/use2.jpg" alt="use2"></p>
<h2><span id="3load-vmlinux">3.load vmlinux</span></h2><p>   å½“å»ºç«‹è¿æ¥åä¸€èˆ¬éƒ½æ˜¯ä¸€äº›æ±‡ç¼–è¯­è¨€ï¼Œè¿™æ—¶å€™éœ€è¦å°†vmlinux loadè¿›DS5æ–¹ä¾¿debug<br><img src="/2018/06/25/tools/ds5-userguide/ds5/load.png" alt="load"></p>
<h2><span id="4æŸ¥çœ‹logbuf">4.æŸ¥çœ‹logbuf</span></h2><p>   logbufçš„å¤§å°ç”±.configä¸­çš„CONIFG_LOG_BUF_SHIFTå†³å®šï¼Œåœ¨init/Kconfigä¸­æœ‰å¯¹åº”çš„è¯´æ˜<br>   å¦‚ä½•ç¡®å®šlog_bufçš„åœ°å€ï¼š<br>   ç›®å‰åœ¨arm64ä¸­log_bufçš„åœ°å€å¯¹åº”çš„æ˜¯system.mapä¸­__log_bufå¯¹åº”çš„åœ°å€ï¼›<br><img src="/2018/06/25/tools/ds5-userguide/ds5/logbuf.jpg" alt="load"><br>   arm32å¯¹åº”çš„åœ°å€ä¸ºsystem.mapçš„log_bufå¯¹åº”åœ°å€çš„åœ°å€ï¼Œéœ€è¦ds5æ‰¾åˆ°æ˜ å°„ä½ç½®ååœ¨é€šè¿‡æ­¤åœ°å€å»æŸ¥çœ‹log_bufä¸­çš„å†…å®¹ï¼š<br><img src="/2018/06/25/tools/ds5-userguide/ds5/logbuf_arm32.jpg" alt="load"></p>
<h2><span id="5load-æºç å•æ­¥è°ƒè¯•">5.load æºç å•æ­¥è°ƒè¯•</span></h2><p><img src="/2018/06/25/tools/ds5-userguide/ds5/load_code.jpg" alt="load"></p>
<h1><span id="å››csatçš„ä½¿ç”¨">å››ï¼šcsatçš„ä½¿ç”¨</span></h1><h2><span id="1castcoresight-access-toolcsat">1.cast:CoreSight Access Tool(CSAT)</span></h2><p>  DS-5çš„å‘½ä»¤è¡Œå·¥å…·ï¼Œå¤„ç†å™¨æŒ‚ä½äº†ï¼Œé€šè¿‡DS-5æ— æ³•è¿æ¥ä¸Šï¼Œåªèƒ½ç”¨CASTè¿æ¥ä¸Šï¼Œä½†æ˜¯CSATæ— æ³•è®¿é—®åˆ°å¤„ç†å™¨å†…éƒ¨çš„å¯„å­˜å™¨ï¼›<br>ä¸€èˆ¬è®¿é—®æ­¥éª¤ï¼š<br>    è¯»å¯„å­˜å™¨,å¦‚æœä¸ok,è¯´æ˜æ€»çº¿æŒ‚äº†ï¼›<br>    è¯»dram,å¦‚æœdramä¸ok,è¯´æ˜mbusæŒ‚äº†ï¼›<br>    è¯»PC,å¦‚æœPCè¯»å–ä¸ok,è¯´æ˜CPUæŒ‚äº†</p>
<h2><span id="2csat-amp-ds-5-diff">2.CSAT &amp; DS-5 diff</span></h2><p>  CSAT:é€šè¿‡APBæ€»çº¿è¿æ¥ï¼ŒCPUæŒ‚æ­»ä¹‹åè¿˜èƒ½è¿æ¥ä¸Šï¼Œä¸èƒ½è®¿é—®åˆ°CPUå†…éƒ¨çš„å¯„å­˜å™¨<br>  DS5ï¼šé€šè¿‡CPUè¿æ¥ï¼ŒCPUæŒ‚æ­»ä¹‹åæ— æ³•è¿æ¥ä¸Šï¼Œèƒ½å¤Ÿè®¿é—®åˆ°CPUå†…éƒ¨çš„å¯„å­˜å™¨</p>
<h2><span id="3csatçš„å‘½ä»¤">3.CSATçš„å‘½ä»¤</span></h2><ol>
<li>æ‰“å¼€DS5çš„å‘½ä»¤è¡Œï¼›</li>
<li>è¾“å…¥ä»¥ä¸‹å‘½ä»¤ï¼š</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">csat</span><br><span class="line">  con USB</span><br><span class="line">  chain dev=auto clk=A</span><br><span class="line">  dvo 0</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>command</th>
<th style="text-align:right">short name</th>
<th style="text-align:center">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>dpmemread</td>
<td style="text-align:right">dmr</td>
<td style="text-align:center">Read mememory</td>
</tr>
<tr>
<td>dpmemwrite</td>
<td style="text-align:right">dmw</td>
<td style="text-align:center">Write memory</td>
</tr>
<tr>
<td>dpfileload</td>
<td style="text-align:right">dfl</td>
<td style="text-align:center">Load a file into memory</td>
</tr>
<tr>
<td>dpfilesave</td>
<td style="text-align:right">dfs</td>
<td style="text-align:center">Save a block of memory to file.</td>
</tr>
</tbody>
</table>
<p>example:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">dmr 0 0x00010000 0x50</span><br><span class="line">#save a block of memory to file</span><br><span class="line">dfs 0 0x047fb000 0x350 dram2.bin</span><br><span class="line">#load a file into memory</span><br><span class="line">dfl 0 bin 0x8000 myfile.bin Load binary file into 0x8000 on AP 0</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/06/25/other/TYPE-Cè€³æœºé€‚é…å·¥ä½œ/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="dongka">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="çŸ¥è¯†æ€»ç»“">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/25/other/TYPE-Cè€³æœºé€‚é…å·¥ä½œ/" itemprop="url">å…¨å¿—TYPE-Cä½¿ç”¨ä»‹ç»</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-06-25T00:07:09+00:00">
                2018-06-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/TYPE-C/" itemprop="url" rel="index">
                    <span itemprop="name">TYPE-C</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>æœ‰æ— TYPE-Cæ–¹æ¡ˆï¼Œä¸»ä»è¯†åˆ«å’Œè€³æœºçš„æ’æ‹”æ£€æµ‹ä¸åŒ;æœ‰TYPE-Cæƒ…å†µä¸‹ï¼Œä¸»è¦ä¸ºTYPE-Cé€»è¾‘è¿›è¡Œä¾¦æµ‹;è€Œæ²¡æœ‰TYPE-Cçš„æ–¹æ¡ˆ;ä¸»ä»åŒºåˆ†éœ€è¦USB-ID detectç®¡è„šè¿›è¡Œåˆ¤æ–­,è€³æœºåˆ™é HP-DETè¿›è¡ŒåŒºåˆ†;</p>
<h1><span id="ä¼ ç»Ÿä¾¦æµ‹æ–¹å¼">ä¼ ç»Ÿä¾¦æµ‹æ–¹å¼</span></h1><h2><span id="ä¸»ä»ä¾¦æµ‹">ä¸»ä»ä¾¦æµ‹</span></h2><p><img src="/2018/06/25/other/TYPE-Cè€³æœºé€‚é…å·¥ä½œ/usb_id_detect.jpg" alt="usb_id_detect"></p>
<p>åœ¨æ²¡æœ‰TYPE-Cçš„ç¡¬ä»¶ä¸Šï¼Œä¸»è¦é USB-IDç®¡è„šçš„ä¸Šä¸‹æ‹‰æ¥åŒºåˆ†ä¸»ä»;</p>
<h1><span id="è€³æœºä¾¦æµ‹">è€³æœºä¾¦æµ‹</span></h1><h2><span id="è€³æœºç»“æ„">è€³æœºç»“æ„</span></h2><p>3.5mmè€³æœºæ’å¤´æœ‰ä¸‰æ®µï¼ˆTRS,Tip-Ring-Sleeveï¼‰å’Œå››æ®µï¼ˆTRRS,Tip-Ring-Sleeveï¼‰ä¹‹åˆ†ï¼Œå…¶ä¸­ä¸‰æ®µçš„ä¸å¸¦éº¦å…‹é£ï¼Œå°¾æ®µï¼ˆSleeve)æ˜¯å…¬å…±åœ°ï¼›ä¸­é—´ç¯ï¼ˆRingï¼‰æ˜¯å³å£°é“ï¼Œå°–éƒ¨ï¼ˆTipï¼‰æ˜¯å·¦å£°é“ï¼Œå››èŠ‚çš„åˆ†ä¸¤ç§ï¼Œä¸€ç§æ˜¯CTIA,ä¸€ç§æ˜¯OMTP;</p>
<p><img src="/2018/06/25/other/TYPE-Cè€³æœºé€‚é…å·¥ä½œ/è€³æœºç»“æ„.png" alt="è€³æœºç»“æ„"></p>
<p>HP-Lè€³æœºå·¦å£°é“ï¼ŒHP-Rè€³æœºå³å£°é“ï¼ŒGNDæ¥åœ°ï¼ŒV-Micè¯­éŸ³éº¦å…‹é£</p>
<h2><span id="è€³æœºåº§ä»¥åŠä¼ ç»Ÿè€³æœºä¾¦æµ‹ä»‹ç»">è€³æœºåº§ä»¥åŠä¼ ç»Ÿè€³æœºä¾¦æµ‹ä»‹ç»</span></h2><p>è€³æœºåº§åˆ†ä¸ºæ”¯æŒæ¬§æ ‡è®¾è®¡çš„è€³æœºåº§å’Œæ”¯æŒç¾æ ‡çš„è€³æœºåº§ã€‚å¦å¤–ä»è€³æœºåº§å·¦å£°é“çš„æ£€æµ‹æ–¹å¼æ¥åˆå¯ä»¥åˆ†ä¸ºâ€Normal-closed typeâ€(å¸¸é—­å‹)å’Œâ€œNormal  -typeâ€(å¸¸å¼€å‹)ä¸¤ç§ã€‚è®¾è®¡å›¾å¦‚ä¸‹ï¼š</p>
<p><img src="/2018/06/25/other/TYPE-Cè€³æœºé€‚é…å·¥ä½œ/è€³æœºåº§å­.png" alt="è€³æœºåº§å­"></p>
<p>. åœ¨å¸¸é—­å‹ä¸­ï¼Œä¸æ¥è€³æœºæ—¶ï¼Œè€³æœºåº§å·¦å£°é“å’Œæ£€æµ‹ç«¯HS-DETæ¥è§¦ï¼Œæ¥å…¥è€³æœºæ—¶ï¼ŒHS-DETä¸HPH-Lä¸å¯¼é€š</p>
<p>. åœ¨å¸¸å¼€å‹ä¸­ï¼Œä¸æ¥è€³æœºæ—¶ï¼Œè€³æœºåº§å·¦å£°é“å’Œæ£€æµ‹ç«¯HS-DETä¸æ¥è§¦ï¼Œæ’å…¥è€³æœºæ—¶ï¼ŒHS-DETä¸HPH-Lå¯¼é€š</p>
<p><img src="/2018/06/25/other/TYPE-Cè€³æœºé€‚é…å·¥ä½œ/headphone.jpg" alt="è€³æœºä¾¦æµ‹ç”µè·¯"></p>
<p>å¦‚å›¾ä¸ºå¸¸å¼€å‹ç»“æ„ï¼ŒHP-DETä¸Šæ‹‰ï¼Œå½“æ’å…¥è€³æœºåHP-DETå’ŒHP-OUTLå¯¼é€šï¼ŒDETä¸‹æ‹‰å¼•èµ·è½¯ä»¶ä¸­æ–­ã€‚è½¯ä»¶ä¸Šé€šè¿‡debounceåï¼Œæ£€æµ‹åˆ°æŒç»­çš„ä½ç”µå¹³ï¼Œäºæ˜¯è®¤ä¸ºè€³æœºæ’å…¥ï¼›è¿™æ—¶å€™éœ€è¦åˆ¤æ–­ï¼Œæ’å…¥çš„è¿˜æ˜¯ä¸‰æ®µè¿˜æ˜¯å››æ®µï¼Œå¹³å°ä¸Šæ‰“å¼€mic_bias,å½“æ’å…¥çš„æ˜¯ä¸‰æ®µè€³æœºï¼ŒMICè¢«æ‹‰ä½ï¼Œäºæ˜¯åˆ¤æ–­ä¸ºä¸‰æ®µè€³æœºï¼›è‹¥ä¸ºå››æ®µè€³æœºï¼ŒMICæ¥è¿‘äºMIC_BIASï¼Œè½¯ä»¶åˆ¤æ–­è¯¥å¤„çš„ç›´æµç”µå‹ä¸ºå››æ®µè€³æœºï¼›å½“æŒ‰é”®æŒ‰ä¸‹æ—¶ï¼ŒMICçš„ç”µå‹å‘ç”Ÿå˜åŒ–ï¼Œè§¦å‘äº†ç³»ç»Ÿä¸­æ–­ï¼Œä¹‹åè½¯ä»¶é€šè¿‡é‡‡æ ·è¯¥å¤„çš„ç”µå‹å€¼ç¡®å®šæŒ‰ä¸‹äº†å“ªä¸€ä¸ªæŒ‰é”®ï¼›</p>
<h1><span id="type-cæ–¹æ¡ˆä¾¦æµ‹æ–¹å¼è®²è§£">TYPE-Cæ–¹æ¡ˆä¾¦æµ‹æ–¹å¼è®²è§£</span></h1><h2><span id="type-cä¸»è¦ç”µè·¯å¦‚ä¸‹">TYPE-Cä¸»è¦ç”µè·¯å¦‚ä¸‹</span></h2><p><img src="/2018/06/25/other/TYPE-Cè€³æœºé€‚é…å·¥ä½œ/TYPE-Cå…³é”®ç”µè·¯.png" alt="TYPE-Cå…³é”®ç”µè·¯"></p>
<p>Type-Cè¿æ¥å¹¶æ²¡æœ‰åœ¨ç‰©ç†ç»“æ„ä¸ŠåŒºåˆ†DFP(Host)å’ŒUFP(Device),æ— è¿æ¥æ—¶DFPæœªç»™VBUSä¾›ç”µï¼Œè¿æ¥åé€šè¿‡CCä¿¡å·çº¿é…ç½®ï¼Œç¡®è®¤è¿æ¥æœ‰æ•ˆï¼ŒVBUSä¾›ç”µæ‰“å¼€å¹¶ç¡®è®¤ä½¿ç”¨å“ªä¸€ä¸ªç«¯å£ä¼ è¾“æ•°æ®;<br><strong>çŠ¶æ€è¯´æ˜</strong></p>
<p><img src="/2018/06/25/other/TYPE-Cè€³æœºé€‚é…å·¥ä½œ/cc_logic.jpg" alt="cc_logic"></p>
<p><strong>å¦‚å›¾æ‰€ç¤º</strong></p>
<p>DFPçš„CC1/CC2ä¼šæ¥ä¸Šæ‹‰ç”µé˜»Rpæˆ–ç”µæµæºï¼ŒUFPçš„CC1/CC2ä¼šæ¥ä¸‹æ‹‰ç”µé˜»Rd,AUDIOè®¾å¤‡åˆ™ä¼šæ¥ä¸¤ä¸ªä¸‹æ‹‰ç”µé˜»</p>
<p>å¦‚ä½•ç¡®è®¤å½“å‰TYPE_Cæ¥å…¥è®¾å¤‡ç±»å‹:</p>
<pre><code>echo 1 &gt; /sys/class/axp/axp_num
echo 0x37 &gt; /sys/class/axp_reg &amp;&amp; cat /sys/class/axp/axp_reg
</code></pre><p>è‹¥è¯»å‡ºçŠ¶æ€ä¸ºATTACH_SNK è¯´æ˜æ¥å…¥çš„æ˜¯é€‚é…å™¨æˆ–pc<br>è‹¥è¯»å‡ºçš„çŠ¶æ€ä¸ºATTACH_SOURCE è¯´æ˜æ­¤æ—¶ä½œä¸ºhost<br>å¦‚è¯»å‡ºä¸ºAUDIO_ACSY,è¯´æ˜æ­¤æ—¶ä¸ºéŸ³é¢‘è®¾å¤‡</p>
<p><img src="/2018/06/25/other/TYPE-Cè€³æœºé€‚é…å·¥ä½œ/type_c_detect.jpg" alt="type_c_detect"></p>
<p><strong>TS5USBA224RSWR</strong>ï¼š</p>
<p> ç”¨äºå°†D-,D+åœ¨(USB0-DM,USB0-DP),(HPOUTL,HPOUTR)ä¸¤ç§æ¨¡å¼ä¹‹é—´åˆ‡æ¢ï¼›ç”±äºVBUSé»˜è®¤ä½åï¼Œæ— æ³•æ»¡è¶³é€šè¿‡SELåˆ‡æ¢çŠ¶æ€ï¼Œæ•…VBUSä¸€èˆ¬è®¾ç½®ä¸ºé«˜ï¼›é€šè¿‡ASELæ¥è®¾ç½®é«˜ä½å®ç°åˆ‡æ¢</p>
<p><strong>TS3A226AE</strong>:</p>
<p>å¯ä»¥ç”¨äºåŒºåˆ†ä¸‰å››èŠ‚è€³æœºï¼Œå¹¶ä¸”å¯ä»¥å°†MICå’ŒGROUNDåŒºåˆ†å‡ºæ¥ï¼Œé™ä½è½¯ä»¶è®¾è®¡å¤æ‚åº¦ï¼›</p>
<p>ä½¿ç”¨TYPE-Cæ–¹æ¡ˆæ—¶ï¼ŒTYPE-C ä¸­æ–­æœåŠ¡ç¨‹åºè´Ÿè´£å°†D-,D+é€‰æ‹©ä¸ºUSBæ¨¡å¼çš„Dp,Dmæˆ–è€…ä¸ºè€³æœºæ¨¡å¼HP-OUTL,HP-OUTR;å¹¶é€šçŸ¥éŸ³é¢‘é©±åŠ¨è€³æœºæ¥å…¥;</p>
<h2><span id="è½¯ä»¶æµç¨‹ä¸º">è½¯ä»¶æµç¨‹ä¸ºï¼š</span></h2><p>ä¸€ï¼šbmué©±åŠ¨äº§ç”Ÿä¸­æ–­ï¼š</p>
<pre><code>irqreturn_t axp_tc_in_isr(int irq, void *data)
{
    struct axp_charger_dev *chg_dev = data;
    #ifdef CONFIG_TYPE_C_AUDIO
    struct axp_usb_info *usb = chg_dev-&gt;spy_info-&gt;usb;
    u8 cc_mode = 0; 
    /*axp_usbac_in(chg_dev);*/
    cc_mode = usb-&gt;get_cc_mode(chg_dev); //è·å–cc ä¾¦æµ‹ç»“æœ
    if (cc_mode == AUDIO_ACSY) {    //å¦‚æœä¸ºéŸ³é¢‘è®¾å¤‡
            usb-&gt;set_sel_mode(chg_dev, 1);  //D+ D- è¿æ¥åˆ°è€³æœºçš„å·¦å³å£°é“
            call_notifier_call_chain(1);    //é€šçŸ¥è€³æœºé©±åŠ¨è€³æœºæ¥å…¥
    } else {
            usb-&gt;set_sel_mode(chg_dev, 0); //D+ D- è¿æ¥åˆ° USBçš„ Dp,Dmå£
            call_notifier_call_chain(0);   //é€šçŸ¥è€³æœºé©±åŠ¨æ‹”å‡º
    }    
    #endif
    axp_change(chg_dev);
    return IRQ_HANDLED;
}
</code></pre><p>äºŒï¼šè€³æœºæ¥å—åˆ°é€šçŸ¥ï¼š</p>
<pre><code>static int type_c_chain_notify(struct notifier_block *nb, unsigned long mode, void *_unused)
{
    struct mc_private *ctx = container_of(nb, struct mc_private, type_c_chain_nb);

    if (mode) {
            ctx-&gt;detect_state = PLUG_IN; //åˆ‡æ¢æ¥å…¥çŠ¶æ€
            printk(&quot;%s PLUG_IN&quot;, __func__);
    } else {
            ctx-&gt;detect_state = PLUG_OUT;
            printk(&quot;%s PLUG_OUT&quot;, __func__);
    }

    schedule_delayed_work(&amp;ctx-&gt;hs_detect_work,
                            msecs_to_jiffies(10)); //æ‰§è¡ŒéŸ³é¢‘ç›¸å…³çš„å¤„ç†å‡½æ•°
    return 0;
}
</code></pre><h1><span id="è½¯ä»¶é…ç½®demo">è½¯ä»¶é…ç½®demo</span></h1><p><strong>ä½¿èƒ½TYPE-C SINKä¸SOURCE æ£€æµ‹åŠŸèƒ½ï¼š</strong></p>
<p>ä¸€ï¼šsys_config.fexä¸­ï¼š</p>
<pre><code>usb_id_gpio = &quot;axp_ctrl&quot;
</code></pre><p>äºŒï¼šdeconfigä¸­</p>
<pre><code>CONFIG_TYPE_C=y
</code></pre><p><strong>ä½¿èƒ½TYPE-Cè€³æœºåŠŸèƒ½</strong></p>
<p>ä¸€ï¼šå¦‚åŸç†å›¾æ‰€ç¤ºï¼Œä½¿ç”¨çš„æ˜¯PH10ä½œä¸ºé€‰é€šç®¡è„šï¼Œæ•…å¯¹pmu_typc_c_selè¿›è¡Œé…ç½®</p>
<pre><code>[charger0]
 compatible                 = &quot;bmu1760-charger&quot;
pmu_type_c_sel             = port:PH10&lt;1&gt;&lt;default&gt;&lt;default&gt;&lt;0&gt;
 pmu_chg_ic_temp            = 0
pmu_battery_rdc            = 100
 pmu_battery_cap            = 4200
</code></pre><p>äºŒï¼šdeconfigä¸­</p>
<pre><code>CONFIG_TYPE_C_AUDIO=y
</code></pre>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/06/19/memory/memory-process/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="dongka">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="çŸ¥è¯†æ€»ç»“">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/19/memory/memory-process/" itemprop="url">ç¨‹åºçš„å†…å­˜ç©ºé—´</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-06-19T08:00:03+00:00">
                2018-06-19
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/å†…å­˜ç®¡ç†/" itemprop="url" rel="index">
                    <span itemprop="name">å†…å­˜ç®¡ç†</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1><span id="ä¸€å†…æ ¸ç©ºé—´å’Œç”¨æˆ·ç©ºé—´">ä¸€ï¼šå†…æ ¸ç©ºé—´å’Œç”¨æˆ·ç©ºé—´</span></h1><p>Linuxçš„è™šæ‹Ÿåœ°å€ç©ºé—´èŒƒå›´æ˜¯0~4G,linuxå†…æ ¸å°†è¿™4Gç©ºé—´åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œå°†æœ€é«˜çš„1Gå­—èŠ‚ï¼ˆä»è™šæ‹Ÿåœ°å€0xC0000000åˆ°0xFFFFFFFFï¼‰ä¾›å†…æ ¸ä½¿ç”¨ï¼Œç§°ä¸ºâ€œå†…æ ¸ç©ºé—´â€ã€‚è€Œå°†è¾ƒä½çš„3Gå­—èŠ‚ï¼ˆä»è™šæ‹Ÿåœ°å€0X00000000åˆ°0xBFFFFFFFFï¼‰ä¾›å„ä¸ªè¿›ç¨‹ä½¿ç”¨ï¼Œç§°ä¸ºâ€œç”¨æˆ·ç©ºé—´â€ã€‚å› ä¸ºæ¯ä¸ªè¿›ç¨‹å¯ä»¥é€šè¿‡ç³»ç»Ÿè°ƒç”¨è¿›å…¥å†…æ ¸ï¼Œå› æ­¤ï¼ŒLinuxå†…æ ¸ç”±ç³»ç»Ÿå†…çš„æ‰€æœ‰è¿›ç¨‹å…±äº«ã€‚äºæ˜¯ï¼Œä»å…·ä½“è¿›ç¨‹çš„è§’åº¦æ¥çœ‹ï¼Œæ¯ä¸ªè¿›ç¨‹å¯ä»¥æ‹¥æœ‰4Gå­—èŠ‚çš„è™šæ‹Ÿç©ºé—´<br>æ¯ä¸ªè¿›ç¨‹çš„ç”¨æˆ·ç©ºé—´éƒ½æ˜¯å®Œå…¨ç‹¬ç«‹ï¼Œäº’ä¸ç›¸å¹²ï¼Œç”¨æˆ·è¿›ç¨‹å„è‡ªæœ‰ä¸åŒçš„é¡µè¡¨ã€‚è€Œå†…æ ¸ç©ºé—´æ˜¯æœ‰å†…æ ¸è´Ÿè´£æ˜ å°„çš„ï¼Œä¸éšè¿›ç¨‹æ”¹å˜ï¼Œæ˜¯å›ºå®šçš„ã€‚å†…æ ¸ç©ºé—´æœ‰è‡ªå·±å¯¹åº”çš„é¡µè¡¨ï¼›<br>è¿™é‡ŒæŒ‡çš„32ä½å†…æ ¸åœ°å€ç©ºé—´åˆ’åˆ†ï¼Œ64ä½å†…æ ¸åœ°å€ç©ºé—´æ˜¯ä¸åŒçš„<br><img src="/2018/06/19/memory/memory-process/memory_process/è¿›ç¨‹ç©ºé—´.png" alt="è¿›ç¨‹ç©ºé—´åˆ†å¸ƒ"></p>
<h2><span id="11å†…æ ¸ç©ºé—´">1.1:å†…æ ¸ç©ºé—´</span></h2><p>linuxå†…æ ¸åœ¨å¯åŠ¨çš„æ—¶å€™ä¼šæ‰“å°å‡ºå†…æ ¸ç©ºé—´çš„å¸ƒå±€å›¾ï¼š<br>init/mian.c:<br>    start_kernel-&gt;mm_init-&gt;mem_init<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Memory: 996228K/1048576K available (9216K kernel code, 1381K rwdata, 2940K rodata, 1024K init, 397K bss, 44156K reserved, 8192K cma-reserved, 253952K highmem)</span><br><span class="line">[    0.000000] Virtual kernel memory layout:</span><br><span class="line">[    0.000000]     vector  : 0xffff0000 - 0xffff1000   (   4 kB)</span><br><span class="line">[    0.000000]     fixmap  : 0xffc00000 - 0xfff00000   (3072 kB)</span><br><span class="line">[    0.000000]     vmalloc : 0xf0800000 - 0xff800000   ( 240 MB)</span><br><span class="line">[    0.000000]     lowmem  : 0xc0000000 - 0xf0000000   ( 768 MB)</span><br><span class="line">[    0.000000]     pkmap   : 0xbfe00000 - 0xc0000000   (   2 MB)</span><br><span class="line">[    0.000000]     modules : 0xbf000000 - 0xbfe00000   (  14 MB)</span><br><span class="line">[    0.000000]       .text : 0xc0008000 - 0xc0a00000   (10208 kB) //ä»£ç æ®µ</span><br><span class="line">[    0.000000]       .init : 0xc0e00000 - 0xc0f00000   (1024 kB)  //initæ®µ åŒ…å«äº†å¤§éƒ¨åˆ†æ¨¡å—çš„åˆå§‹åŒ–æ•°æ®</span><br><span class="line">[    0.000000]       .data : 0xc0f00000 - 0xc1059518   (1382 kB)  //æ•°æ®æ®µçš„èµ·å§‹å’Œç»“æŸåœ°å€ï¼Œä¿å­˜å¤§éƒ¨åˆ†å†…æ ¸çš„å˜é‡</span><br><span class="line">[    0.000000]        .bss : 0xc105b000 - 0xc10be54c   ( 398 kB)  //BSSæ®µçš„å¼€å§‹å’Œç»“æŸåœ°å€ï¼ŒåŒ…å«åˆå§‹åŒ–ä¸º0çš„æ‰€æœ‰é™æ€å…¨å±€å˜é‡</span><br><span class="line">[    0.000000] SLUB: HWalign=64, Order=0-3, MinObjects=0, CPUs=4, Nodes=1</span><br></pre></td></tr></table></figure></p>
<p><img src="/2018/06/19/memory/memory-process/memory_process/å†…æ ¸ç©ºé—´.png" alt="å†…æ ¸ç©ºé—´"></p>
<p>å†…æ ¸ç©ºé—´åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼šZONE_DMA(16M),ZONE_NORMAL(16~896),ZONE_HIGMEM(896~1G),é«˜ç«¯å†…å­˜<br>å†…æ ¸åœ°å€ç©ºé—´åˆ†ä¸ºç‰©ç†å†…å­˜æ˜ å°„åŒºï¼Œè™šæ‹Ÿå†…å­˜åˆ†é…åŒºï¼Œé«˜ç«¯é¡µé¢æ˜ å°„åŒºï¼Œä¸“ç”¨é¡µé¢æ˜ å°„åŒºä¿ç•™åŒº<br>å†…æ ¸ç©ºé—´ä¸­å­˜æ”¾çš„æ˜¯å†…æ ¸ä»£ç å’Œæ•°æ®ï¼Œè€Œè¿›ç¨‹çš„ç”¨æˆ·ç©ºé—´ä¸­å­˜æ”¾çš„æ˜¯ç”¨æˆ·ç¨‹åºçš„ä»£ç å’Œæ•°æ®ã€‚ä¸ç®¡æ˜¯å†…æ ¸ç©ºé—´è¿˜æ˜¯ç”¨æˆ·ç©ºé—´ï¼Œå®ƒä»¬éƒ½å¤„äºè™šæ‹Ÿç©ºé—´ä¸­ï¼Œè™½ç„¶å†…æ ¸ç©ºé—´å æ®äº†æ¯ä¸ªè™šæ‹Ÿç©ºé—´çš„æœ€é«˜1GBå­—èŠ‚ï¼Œä½†æ˜ å°„åˆ°ç‰©ç†å†…å­˜å´æ€»æ˜¯ä»æœ€ä½ï¼ˆ0X00000000ï¼‰ï¼Œå¦å¤–ï¼Œä½¿ç”¨è™šæ‹Ÿåœ°å€å¯ä»¥å¾ˆå¥½çš„ä¿æŠ¤å†…æ ¸ç©ºé—´ä¸è¢«ç ´åï¼Œè™šæ‹Ÿåœ°å€åˆ°ç‰©ç†åœ°å€è½¬æ¢è¿‡ç¨‹ä¸­æœ‰æ“ä½œç³»ç»Ÿå’ŒCPUå…±åŒå®Œæˆ<br>å†…æ ¸ç©ºé—´æ˜¯æŒç»­å­˜åœ¨çš„ï¼Œå¹¶ä¸”åœ¨æ‰€æœ‰è¿›ç¨‹ä¸­éƒ½æ˜ å°„åˆ°åŒæ ·çš„ç‰©ç†å†…å­˜ï¼Œå†…æ ¸ä»£ç å’Œæ•°æ®æ€»æ˜¯å¯å¯»å€çš„ï¼Œéšæ—¶å‡†å¤‡å¤„ç†ä¸­æ–­å’Œç³»ç»Ÿè°ƒç”¨ã€‚</p>
<h2><span id="12ç”¨æˆ·ç©ºé—´åˆ†å¸ƒ">1.2:ç”¨æˆ·ç©ºé—´åˆ†å¸ƒ</span></h2><p>ç¨‹åºæ®µï¼ˆTextï¼‰:ç¨‹åºä»£ç åœ¨å†…å­˜ä¸­çš„æ˜ å°„ï¼Œå­˜æ”¾å‡½æ•°ä½“çš„äºŒè¿›åˆ¶ä»£ç ã€‚<br>åˆå§‹åŒ–è¿‡çš„æ•°æ®ï¼ˆDataï¼‰:åœ¨ç¨‹åºè¿è¡Œåˆå·²ç»å¯¹å˜é‡è¿›è¡Œåˆå§‹åŒ–çš„æ•°æ®<br>æœªåˆå§‹åŒ–è¿‡çš„æ•°æ®ï¼ˆBSSï¼‰:åœ¨ç¨‹åºè¿è¡Œåˆæœªå¯¹å˜é‡è¿›è¡Œåˆå§‹åŒ–çš„æ•°æ®<br>æ ˆï¼ˆStackï¼‰ï¼šå­˜å‚¨å±€éƒ¨ï¼Œä¸´æ—¶å˜é‡ï¼Œå‡½æ•°è°ƒç”¨æ—¶ï¼Œå­˜å‚¨å‡½æ•°çš„è¿”å›æŒ‡é’ˆï¼Œç”¨äºæ§åˆ¶å‡½æ•°çš„è°ƒç”¨å’Œè¿”å›ã€‚åœ¨ç¨‹åºå—å¼€å§‹æ—¶è‡ªåŠ¨åˆ†é…å†…å­˜ï¼Œç»“æŸæ—¶è‡ªåŠ¨é‡Šæ”¾å†…å­˜ï¼Œå…¶æ“ä½œæ–¹å¼ç±»ä¼¼äºç»“æ„ä¸­çš„æ ˆï¼›<br>å †ï¼ˆHeapï¼‰ï¼šå­˜å‚¨åŠ¨æ€å†…å­˜åˆ†é…ï¼Œéœ€è¦ç¨‹åºå‘˜æ‰‹å·¥åˆ†é…ï¼Œæ‰‹å·¥é‡Šæ”¾ï¼›</p>
<h2><span id="ä¸‰å†…å­˜æº¢å‡ºå†…å­˜æ³„æ¼å†…å­˜è¶Šç•Œç¼“å­˜åŒºæº¢å‡ºæ ˆæº¢å‡º">ä¸‰ï¼šå†…å­˜æº¢å‡ºï¼Œå†…å­˜æ³„æ¼ï¼Œå†…å­˜è¶Šç•Œï¼Œç¼“å­˜åŒºæº¢å‡ºï¼Œæ ˆæº¢å‡º</span></h2><p>å†…å­˜æº¢å‡ºï¼šè¦æ±‚åˆ†é…çš„å†…å­˜è¶…å‡ºäº†ç³»ç»Ÿèƒ½ç»™äºˆçš„<br>å†…å­˜è¶Šç•Œï¼šç”³è¯·äº†ä¸€å—å†…å­˜ï¼Œåœ¨ä½¿ç”¨è¿™å—çš„æ—¶å€™ï¼Œè¶…å‡ºäº†ä½ ç”³è¯·çš„èŒƒå›´<br>ç¼“å†²åŒºæº¢å‡ºï¼šå½“è®¡ç®—æœºå‘ç¼“å†²åŒºå¡«å……åŒºå†…å¡«å……æ•°æ®ä½æ•°</p>
<p>å‚è€ƒèµ„æ–™ï¼š<br><a href="https://blog.csdn.net/tommy_wxie/article/details/17122923/" target="_blank" rel="noopener">linuxç”¨æˆ·ç©ºé—´ä¸å†…æ ¸ç©ºé—´â€”â€”é«˜ç«¯å†…å­˜è¯¦è§£</a><br><a href="https://blog.csdn.net/u010246947/article/details/9413275" target="_blank" rel="noopener">ARMæ¶æ„å†…æ ¸å¯åŠ¨åˆ†æ-head.S(1.1).vmlinux.ldsé“¾æ¥è„šæœ¬åˆ†æ</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/06/17/memory/memory-mtp/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="dongka">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="çŸ¥è¯†æ€»ç»“">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/17/memory/memory-mtp/" itemprop="url">å†…å­˜ç®¡ç†ï¼ˆäºŒï¼‰mtpæ‹·è´æµç¨‹</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-06-17T00:07:09+00:00">
                2018-06-17
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/å†…å­˜ç®¡ç†/" itemprop="url" rel="index">
                    <span itemprop="name">å†…å­˜ç®¡ç†</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2><span id="èƒŒæ™¯çŸ¥è¯†ä»‹ç»">èƒŒæ™¯çŸ¥è¯†ä»‹ç»</span></h2><p>android ä»3.0å¼€å§‹é›†æˆMTPåŠŸèƒ½ï¼Œä¸»è¦åŸå› æœ‰ä¸‰ä¸ªï¼š<br>1.æ‰‹æœºè¦æ”¯æŒUMSçš„è¯ï¼Œå¿…é¡»è¦æœ‰ä¸€ä¸ªsdå¡ï¼Œå› ä¸ºsdå¡å¾€å¾€é‡‡ç”¨Windowsæ”¯æŒçš„åˆ†åŒºæ ¼å¼ã€‚å¦‚æœæƒ³æŠŠå†…éƒ¨å­˜å‚¨ç©ºé—´é€šè¿‡UMSæŒ‚è½½åˆ°Windowsä¸Šï¼Œåˆ™å†…éƒ¨å­˜å‚¨ç©ºé—´éœ€é‡‡ç”¨ç‰¹å®šçš„åˆ†åŒºæ ¼å¼ã€‚è¿™å¯¹æŸäº›æ‰‹æœºè€Œè¨€æ ¹æœ¬ä¸å¯è¡Œã€‚å› ä¸ºå†…éƒ¨å­˜å‚¨ç©ºé—´æœ¬èº«å¯èƒ½å°±æ˜¯ä¸€ä¸ªè®¾å¤‡ï¼Œå®ƒä»¬é‡‡ç”¨ç»Ÿä¸€çš„åˆ†åŒºæ ¼å¼ã€‚ä¸èƒ½å› ä¸ºéœ€è¦ä½¿ç”¨UMSï¼Œè€Œå†å¢åŠ ä¸€å—ç‰¹å®šçš„åˆ†åŒºæ ¼å¼çš„å­˜å‚¨è®¾å¤‡ã€‚<br>2.UMSæŒ‚è½½åˆ°PCåï¼ŒPCæ“ä½œç³»ç»Ÿæ‹¥æœ‰ç»å¯¹çš„æ§åˆ¶æƒã€‚æ­¤æ—¶ï¼ŒAndroidç³»ç»Ÿæ— æ³•æ“ä½œè¿™äº›è®¾å¤‡ã€‚<br>3.windowæ‰€å å¸‚åœºä»½é¢è¾ƒå¤§ï¼Œæ•…å³ä½¿linuxï¼ŒMacOSæ”¯æŒåŠ›åº¦ä¸å¤Ÿï¼ŒAndroidä¹Ÿè¦é›†æˆçš„ï¼›<br>MTPçš„ä¸»è¦ç¼ºç‚¹ï¼š<br>1.ä¼ è¾“å¤§æ–‡ä»¶çš„é€Ÿåº¦è¾ƒæ…¢ ??<br>2.MTPä¸èƒ½ç›´æ¥ä¿®æ”¹æ–‡ä»¶æœ¬èº«ï¼Œåªèƒ½å…ˆæ‹·è´åˆ°æœ¬åœ°ä¿®æ”¹ï¼Œå®Œæ¯•åå†æ‹·è´å›å»</p>
<h2><span id="mtpåè®®ä»‹ç»">MTPåè®®ä»‹ç»</span></h2><p>MTPä½¿ç”¨è€…åŒ…æ‹¬ä¸¤ä¸ªéƒ¨åˆ†ï¼Œåˆ†åˆ«ä¸ºInitiatorå’ŒResoponder</p>
<ol>
<li>Initiator:ä¸»è¦æ˜¯æŒ‡USB Host,ä¾‹å¦‚PCæœºï¼Œç¬”è®°æœ¬ç­‰ï¼Œåè®®è§„å®šæ‰€æœ‰çš„MTPæ“ä½œåªèƒ½ç”±Initatorå‘èµ·</li>
<li>Responder:ä¸€èˆ¬æ˜¯è¯¸å¦‚æ•°ç ç›¸æœºï¼Œæ™ºèƒ½æ‰‹æœºç­‰å­˜å‚¨åª’ä½“æ–‡ä»¶çš„è®¾å¤‡ï¼ŒResponderåœ¨MTPä¸­çš„ä½œç”¨å°±æ˜¯å¤„ç†Initatorå‘èµ·çš„è¯·æ±‚ã€‚åŒæ—¶ï¼Œå®ƒè¿˜ä¼šæ ¹æ®è‡ªèº«çŠ¶æ€çš„å˜åŒ–å‘é€Eventä»¥é€šçŸ¥Initator.</li>
</ol>
<h1><span id="mtp-åè®®æ ˆ">MTP åè®®æ ˆ</span></h1><ol>
<li>Pyshical Layer(ç‰©ç†å±‚)ï¼šç‰©ç†å±‚åœ¨MTPåè®®ä¸­ç”¨æ¥ä¼ è¾“æ•°æ®ã€‚ç›®å‰æœ‰ä¸‰ç§ç‰©ç†å±‚å¯ä¾›MTPä½¿ç”¨ã€‚å®ƒä»¬åˆ†åˆ«æ˜¯USB:å…¶ä¸»è¦ç‰¹ç‚¹æ˜¯ä¼ è¾“æ–‡ä»¶ï¼ŒåŒæ­¥åª’ä½“æ–‡ä»¶æ—¶é€Ÿåº¦å¿«ï¼Œè€Œä¸”å¯ä»¥å˜å·¥ä½œè¾¹å……ç”µï¼Œè¿™æ˜¯ç›®å‰ç”¨çš„æœ€å¤šçš„ä¸€ç§æ–¹å¼ï¼›IPï¼šåŸºäºIPçš„MTP(ç®€ç§°MTP/TP)å°†é€šè¿‡UPnpæ¥åŒ¹é…å’Œå‘ç°è®¾å¤‡ã€‚å®ƒæ˜¯å®¶åº­ç½‘ç»œä¸­æœ€ç†æƒ³çš„ä¼ è¾“æ–¹å¼ï¼›Bluetooth:MTP/BTæ˜¯æœ€çœç”µï¼ŒåŒæ—¶é€Ÿåº¦æœ€æ…¢çš„ä¸€ç§ä¼ è¾“æ–¹å¼ï¼Œç”¨å¤„è¾ƒå°‘ï¼›</li>
<li>ä¼ è¾“å±‚ï¼šMTPä¸­ï¼Œæ•°æ®ä¼ è¾“æ ¼å¼éµå¾ªPTPåè®®</li>
<li>å‘½ä»¤å±‚ï¼šå®ç°äº†MTPåè®®ä¸­çš„å„ç§å‘½ä»¤ï¼›</li>
</ol>
<p>MTPé‡‡ç”¨å‘½ä»¤-åº”ç­”æ–¹å¼æ¥å·¥ä½œï¼Œ(Initatorå‘é€å‘½ä»¤ç»™Responderå¤„ç†ï¼ŒResponseråé¦ˆå¤„ç†ç»“æœ)ï¼Œè¿™ç§æ–¹å¼ä¸»è¦ç‰¹ç‚¹æœ‰ï¼š</p>
<ol>
<li>æ‰€æœ‰MTPå‘½ä»¤å‡ä»¥Package(æ•°æ®åŒ…)çš„æ–¹å¼åœ¨è®¾å¤‡ä¸¤ç«¯è¿›è¡Œä¼ é€’</li>
<li>Initiatorå¿…é¡»æ¥æ”¶åˆ°å‰ä¸€æ¡æ¶ˆæ¯å¤„ç†ç»“æœï¼Œæ— è®ºæ˜¯æˆåŠŸæˆ–è€…è¶…æ—¶åï¼Œæ‰èƒ½å‘é€ä¸‹ä¸€æ¡æ¶ˆæ¯</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/06/17/memory/memory-hardware-md/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="dongka">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="çŸ¥è¯†æ€»ç»“">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/17/memory/memory-hardware-md/" itemprop="url">å†…å­˜ç®¡ç†ï¼ˆä¸€ï¼‰ç¡¬ä»¶ç¯‡</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-06-17T00:07:09+00:00">
                2018-06-17
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/å†…å­˜ç®¡ç†/" itemprop="url" rel="index">
                    <span itemprop="name">å†…å­˜ç®¡ç†</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2><span id="ä¸€ç»å…¸å­˜å‚¨ç»“æ„å›¾">ä¸€.ç»å…¸å­˜å‚¨ç»“æ„å›¾</span></h2><p><img src="https://mmbiz.qpic.cn/mmbiz_png/Ass1lsY6bysOaeD9VG5JiaTNMibYPxicZnaghCuOMjibmmJgymLicFZBkXdwOReYVV1WfJHPhsU23ibEzhSsbdK87aGg/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1" alt="avatar"> </p>
<pre><code>L0(å¯„å­˜å™¨)-&gt;CPU å¯„å­˜å™¨ä¿å­˜æ¥è‡ªé«˜é€Ÿç¼“å­˜çš„å­—
L1(SRAMï¼‰-&gt;é«˜é€Ÿç¼“å­˜å–è‡ªL2é«˜é€Ÿç¼“å­˜è¡Œ
L2(SRAM)-&gt;é«˜é€Ÿç¼“å­˜å–è‡ªL3é«˜é€Ÿç¼“å­˜çš„é«˜é€Ÿç¼“å­˜è¡Œ
L3(SRAM)-&gt;é«˜é€Ÿç¼“å­˜ä¿å­˜è‡ªå†…å­˜çš„é«˜é€Ÿç¼“å­˜è¡Œ
L4(å†…å­˜)-&gt;å†…å­˜ä¿å­˜è‡ªç£ç›˜ç¼“å­˜çš„ç£ç›˜å—
L5(ç£ç›˜ç¼“å­˜)-&gt;ç£ç›˜ç¼“å­˜ä¿å­˜å–è‡ªç£ç›˜çš„ç£ç›˜å—
L6ç£ç›˜
</code></pre><p>cpuä»ç£ç›˜ä¸­åŠ è½½æ•°æ®,æ”¾åˆ°å†…å­˜ï¼Œä¹‹åå†æ”¾åˆ°å‘Šè¯‰ç¼“å­˜</p>
<h2><span id="äºŒè™šæ‹Ÿåœ°å€å’Œç‰©ç†åœ°å€">äºŒ.è™šæ‹Ÿåœ°å€å’Œç‰©ç†åœ°å€</span></h2><p>åœ¨æ—§çš„æ‰‹æœºä¸­ï¼Œå†…å­˜å¯èƒ½åªæœ‰1G,ä½†æ˜¯æ¯ä¸ªè¿›ç¨‹åœ¨æ‰§è¡Œçš„æ—¶å€™éƒ½ä»¿ä½›æ‰‹æœºæœ‰4gå†…å­˜ï¼›<br><strong>ç‰©ç†åœ°å€(Physical Address)</strong>ï¼šCPUåœ°å€æ€»çº¿ä¼ æ¥çš„åœ°å€ï¼Œç”±ç¡¬ä»¶ç”µè·¯æ§åˆ¶å…¶å«ä¹‰ã€‚ç‰©ç†åœ°å€ä¸­æœ‰å¾ˆå¤§ä¸€éƒ¨åˆ†æ˜¯ç•™ç»™å†…å­˜æ¡ä¸­çš„å†…å­˜çš„ä½†ä¹Ÿå¸¸è¢«æ˜ å°„åˆ°å…¶ä»–å­˜å‚¨å™¨ä¸Šå¦‚æ˜¾å­˜ï¼ŒBIOSç­‰),åœ¨æ²¡æœ‰ä½¿ç”¨è™šæ‹Ÿå­˜å‚¨å™¨çš„æœºå™¨ä¸Šï¼Œè™šæ‹Ÿåœ°å€è¢«ç›´æ¥é€åˆ°å†…å­˜æ€»çº¿ä¸Šï¼Œä½¿å…·æœ‰ç›¸åŒç‰©ç†å­˜å‚¨å™¨è¢«è¯»å†™;è€Œåœ¨ä½¿ç”¨äº†è™šæ‹Ÿå­˜å‚¨å™¨çš„æƒ…å†µä¸‹ï¼Œè™šæ‹Ÿå…·ä½“åœ°å€ä¸æ˜¯è¢«ç›´æ¥é€åˆ°å†…å­˜åœ°å€æ€»çº¿ä¸Šï¼Œè€Œæ˜¯é€åˆ°å­˜å‚¨å™¨ç®¡ç†å•å…ƒMMUï¼ŒæŠŠè™šæ‹Ÿåœ°å€æ˜ å°„ä¸ºç‰©ç†åœ°å€ï¼›æˆ‘ä»¬æŠŠä¸Šé¢å®é™…çš„1Gå†…å­˜å«åšï¼šç‰©ç†åœ°å€<br><strong>è™šæ‹Ÿåœ°å€(Virtual Address)</strong>:æ˜¯é€»è¾‘åœ°å€åˆ°ç‰©ç†åœ°å€å˜æ¢ä¹‹é—´çš„ä¸­é—´å±‚ï¼›è¿›ç¨‹è®¿é—®åˆ°çš„å«åšè™šæ‹Ÿåœ°å€ï¼›<br>è™šæ‹Ÿå†…å­˜æœ‰ä»¥ä¸‹å‡ ä¸ªä½œç”¨ï¼š<br>1.å†…å­˜è®¿é—®ä¿æŠ¤<br>  æœ‰è™šæ‹Ÿå†…å­˜ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è®¾ç½®æ®µç•Œé™æˆ–é¡µè¡¨æƒ³æ¥è®¾å®šè½¯ä»¶è¿è¡Œæ—¶çš„è®¿é—®ç©ºé—´ï¼Œç¡®ä¿è½¯ä»¶è¿è¡Œä½¿ä¸è¶Šç•Œï¼›<br>2.æŒ‰éœ€åˆ†é¡µï¼ˆlazy loadæŠ€æœ¯ï¼‰<br>  å¯ä»¥è®©è½¯ä»¶åœ¨æ²¡æœ‰è®¿é—®æŸè™šæ‹Ÿå†…å­˜åœ°å€æ—¶ï¼Œä¸åˆ†é…è™šæ‹Ÿåœ°å€ï¼Œåœ¨å®é™…è®¿é—®çš„æ—¶å€™ï¼Œåœ¨åŠ¨æ€åˆ†é…ç‰©ç†å†…å­˜<br>å»ºç«‹è™šæ‹Ÿå†…å­˜åˆ°ç‰©ç†å†…å­˜çš„é¡µæ˜ å°„å…³ç³»ï¼›<br>3.é¡µæ¢å…¥æ¢å‡ºï¼ˆpage swap in/out)<br>  æŠŠä¸ç»å¸¸è®¿é—®çš„æ•°æ®æ‰€å çš„å†…å­˜ç©ºé—´ä¸´æ—¶å†™åˆ°ç¡¬ç›˜ä¸Šï¼Œè¿™æ ·å¯ä»¥è…¾å‡ºæ›´å¤šçš„ç©ºé—²ç©ºé—´å‡ºæ¥ç»™åˆ°ç»å¸¸è®¿é—®çš„æ•°æ®ï¼›å½“cpuè®¿é—®åˆ°ä¸ç»å¸¸è®¿é—®çš„æ•°æ®æ—¶ï¼Œå†æŠŠæ•°æ®ä»ç¡¬ä»¶è¯»å…¥åˆ°å†…å­˜ä¸­ï¼›<br>4.å†™æ—¶å¤åˆ¶ï¼ˆcopy on writeï¼‰<br>  ä¸¤ä¸ªè™šæ‹Ÿé¡µçš„æ•°æ®ç›¸åŒæ—¶ï¼Œå¯åªåˆ†é…ä¸€ä¸ªç‰©ç†é¡µæ¡†ï¼Œè¿™æ ·å¦‚æœå¯¹ä¸¤ä¸ªè™šæ‹Ÿé¡µçš„è®¿é—®æ˜¯åªè¯»æ–¹å¼ï¼Œè¿™ä¸¤ä¸ªè™šæ‹Ÿé¡µå¯ä»¥å…±äº«é¡µæ¡†ï¼ŒèŠ‚çœç©ºé—´ï¼›å¦‚æœå½“CPUå¯¹å…¶ä¸­ä¸€ä¸ªè™šæ‹Ÿé¡µè¿›è¡Œäº†å†™æ“ä½œï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªè™šæ‹Ÿé¡µçš„æ•°æ®å†…å®¹ä¸åŒï¼Œéœ€è¦åˆ†é…ä¸€ä¸ªæ–°çš„ç‰©ç†é¡µæ¡†ï¼Œå¹¶å°†ç‰©ç†é¡µæ¡†æ ‡è®°ä¸ºå¯å†™ï¼Œè¿™æ ·ä¸¤ä¸ªè™šæ‹Ÿé¡µé¢å°†æ˜ å°„åˆ°ä¸åŒçš„ç‰©ç†é¡µå¸§ï¼Œç¡®ä¿æ•´ä¸ªå†…å­˜ç©ºé—´çš„æ­£ç¡®è®¿é—®ã€‚</p>
<h2><span id="äºŒé¡µé¡µè¡¨mmu">äºŒ.é¡µï¼Œé¡µè¡¨ï¼ŒMMU</span></h2><p>åœ¨è®²è™šæ‹Ÿåœ°å€åˆ°ç‰©ç†åœ°å€ä¹‹ä¸­å†è¡¥å……å‡ ä¸ªæ¦‚å¿µï¼š<br>é¡µ(page)<br>  <em>æŠŠAPPçš„è™šæ‹Ÿåœ°å€åˆ‡åˆ†ç¨‹è‹¥å¹²ä¸ªå¤§å°ç›¸ç­‰ï¼ˆ4Kï¼‰çš„ç‰‡ï¼Œæ¯ä¸€ç‰‡å°±æ˜¯æˆ‘ä»¬è¯´çš„é¡µ</em><br>é¡µæ¡†ï¼ˆframeï¼‰<br>  *æŠŠç‰©ç†å†…å­˜é¡µæŒ‰â€œé¡µâ€çš„å¤§å°åˆ‡åˆ†ä¸ºè‹¥å¹²å¤§å°ç›¸ç­‰çš„ç‰‡ï¼Œæ¯ä¸€ç‰‡ï¼Œå°±æ˜¯æˆ‘ä»¬æ‰€è¯´çš„é¡µæ¡† </p>
<h2><span id="ä¸‰cpuå¯»æ‰¾é¡µé¢è¿‡ç¨‹">ä¸‰.cpuå¯»æ‰¾é¡µé¢è¿‡ç¨‹</span></h2><pre><code>CPUè·å–æ•°æ®ä¸»è¦æœ‰ä¸¤æ­¥ï¼š
a.é€šè¿‡è™šæ‹Ÿåœ°å€è·å–ç‰©ç†åœ°å€
b.æ ¹æ®ç‰©ç†åœ°å€è·å–æ•°æ®
</code></pre><h3><span id="è·å–ç‰©ç†åœ°å€">è·å–ç‰©ç†åœ°å€</span></h3><p><img src="https://mmbiz.qpic.cn/mmbiz_png/Ass1lsY6bysOaeD9VG5JiaTNMibYPxicZnaBdia2Vt94nvPcnj4aYqWRrLibeKQONayr9azNLWEeiabiay7ibIF3ooxibBw/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1" alt="è·å–ç‰©ç†åœ°å€"><br>    [a].CPUå‘MMUå‘é€è™šæ‹Ÿåœ°å€<br>    [b].MMUæŸ¥è¯¢å¿«è¡¨TLB<br>        å—è¡¨å‘½ä¸­ï¼šä»å—è¡¨ä¸­è·å–ç‰©ç†åœ°å€ï¼Œç”±MMUç»§ç»­æ ¹æ®ç‰©ç†åœ°å€åŒ¹é…æ•°æ®é¡µæ­¥éª¤[a]<br>        å—è¡¨ä¸å‘½ä¸­ï¼šæŸ¥è¯¢é¡µè¡¨æ­¥éª¤[c]<br>    [c]:ä»é«˜é€Ÿç¼“å­˜æŸ¥è¯¢é¡µè¡¨<br>     â€œé«˜é€Ÿç¼“å­˜â€ç¼“å­˜é¡µæ¡†ï¼Œè€Œé¡µè¡¨å­˜å‚¨äºé¡µæ¡†ä¸­ï¼Œå› æ­¤è¯»å–é¡µè¡¨å®é™…ä¸Šä¹Ÿæ˜¯è¯»é¡µï¼ˆé¡µè¡¨çš„ç‰©ç†åœ°å€æœ‰å•ç‹¬çš„å¯„å­˜å™¨ä¿å­˜ï¼‰<br>     é«˜é€Ÿç¼“å­˜å‘½ä¸­ï¼šä»é«˜é€Ÿç¼“å­˜è·å–ç‰©ç†åœ°å€ï¼Œå¹¶æ›´æ–°å¿«è¡¨ï¼Œè¿›å…¥[æ­¥éª¤a]<br>     é«˜é€Ÿç¼“å­˜ä¸å‘½ä¸­ï¼šæŸ¥è¯¢å†…å­˜ä¸­çš„é¡µè¡¨[æ­¥éª¤d]<br>     [d]ä»å†…å­˜ä¸­æŸ¥è¯¢é¡µè¡¨<br>     é¡µè¡¨ä¿å­˜äº†æ‰€æœ‰è™šæ‹Ÿåœ°å€çš„æ˜ å°„å…³ç³»ï¼Œè€Œä¸ç®¡é¡µæ˜¯å¦æœ‰æ˜ å°„ç‰©ç†é¡µæ¡†ã€‚å› æ­¤ä»å†…å­˜é¡µè¡¨ä¸­è‚¯å®šèƒ½â€œå‘½ä¸­â€é¡µã€‚ä»é¡µè¡¨è·å–è™šæ‹Ÿåœ°å€çš„æ˜ å°„å…³ç³»åï¼Œè¿›å…¥æ­¥éª¤e<br>     [e]æŠŠæŸ¥è¯¢çš„é¡µè¡¨æƒ³è®°å½•åˆ°é«˜é€Ÿç¼“å­˜<br>     [f]MMUä»é«˜é€Ÿç¼“å­˜ä¸­è·å–é¡µè¡¨é¡¹<br>        è™šæ‹Ÿåœ°å€æœ‰åˆ†é…ç‰©ç†é¡µæ¡†ï¼›è½¬æ¢ç‰©ç†åœ°å€å¹¶æ›´æ–°å—è¡¨ï¼Œç”±MMUç»§ç»­æ ¹æ®ç‰©ç†åœ°å€åŒ¹é…æ•°æ®é¡µ<br>        è™šæ‹Ÿåœ°å€æ²¡åˆ†é…ç‰©ç†é¡µæ¡†ï¼šè§¦å‘ç¼ºé¡µä¸­æ–­<br>    [g]è¿›å…¥ç¼ºé¡µä¸­æ–­å¤„ç†ç¨‹åº<br>    [h]ä¸ºè™šæ‹Ÿé¡µåˆ†é…ç‰©ç†é¡µæ¡†<br>        å¦‚æœæ— ç©ºé—²ç‰©ç†é¡µæ¡†ï¼Œåˆ™æ ¹æ®LRUç®—æ³•é€‰æ‹©éœ€è¦æ·˜æ±°çš„é¡µï¼Œè¦æ·˜æ±°çš„é¡µå¦‚æœæ˜¯è„æ•°æ®å°±å›åˆ·ï¼Œå¦åˆ™ç›´æ¥ä¸¢å¼ƒæˆ–ç½®æ¢åˆ°ç£ç›˜çš„äº¤æ¢åˆ†åŒºä¸­<br>        ç„¶åï¼Œä»ç£ç›˜ä¸­è·å–é¡µä¿¡æ¯æ›´æ–°åˆ°ç‰©ç†é¡µæ¡†ï¼Œæ›´æ–°å†…å­˜é¡µè¡¨<br>    [i]ç¼ºé¡µä¸­æ–­å¤„ç†çš„æœ€å<br>        ä¿®æ”¹CPUå¯„å­˜å™¨ï¼Œä½¿å¾—é‡æ–°å¯åŠ¨å¯¼è‡´ç¼ºé¡µçš„æŒ‡ä»¤ï¼Œè¿”å›[æ­¥éª¤a]é‡æ–°æ‰§è¡Œ</p>
<h3><span id="æ ¹æ®ç‰©ç†åœ°å€è·å–å®é™…æ•°æ®">æ ¹æ®ç‰©ç†åœ°å€è·å–å®é™…æ•°æ®</span></h3><p><img src="https://mmbiz.qpic.cn/mmbiz_png/Ass1lsY6bysOaeD9VG5JiaTNMibYPxicZnaMfh510NLONxyc2CSvYr3Vrwqyf9tiajI1jPAuD16Kzm9mOvqQdZTiaJg/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1" alt="è·å–æ•°æ®"><br>    [A]MMUè·å–åˆ°ç‰©ç†åœ°å€åï¼Œæ ¹æ®ç‰©ç†åœ°å€æŸ¥è¯¢é«˜é€Ÿç¼“å­˜<br>        é«˜é€Ÿç¼“å­˜å‘½ä¸­ï¼šCPUç›´æ¥ä»é«˜é€Ÿç¼“å­˜è·å–æ•°æ®<br>        é«˜é€Ÿç¼“å­˜ä¸å‘½ä¸­ï¼šæŸ¥è¯¢ç‰©ç†å†…å­˜[æ­¥éª¤B]<br>    [B]æ ¹æ®ç‰©ç†åœ°å€ï¼Œè·å–ç‰©ç†å†…å­˜ä¸­çš„æ•°æ®<br>    [C]ç¡¬ä»¶å®ç°æŠŠæ•°æ®é¡µè®°å½•åˆ°é«˜é€Ÿç¼“å­˜ä¸­<br>    [D]cpuç›´æ¥ä»é«˜é€Ÿç¼“å­˜ä¸­è·å–æ•°æ®</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/02/25/pinctrl/sunxi_pinctrl/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="dongka">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="çŸ¥è¯†æ€»ç»“">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/25/pinctrl/sunxi_pinctrl/" itemprop="url">gpio pinctrlçš„ä½¿ç”¨demo</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-02-25T10:07:09+00:00">
                2018-02-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/gpio/" itemprop="url" rel="index">
                    <span itemprop="name">gpio</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>æœ¬æ–‡ä¸»æ—¨åœ¨äºä»‹ç»gpioåŠŸèƒ½çš„ä½¿ç”¨ï¼Œæ•…ä¸ä¼šå»ç»†å‰–pinctrlä¸­çš„ä»£ç æ¡†æ¶ï¼›ä¸ºäº†ä»‹ç»gpioåœ¨å…¨å¿—å¹³å°çš„ä½¿ç”¨ï¼Œåˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼Œubootä¸­çš„gpioä½¿ç”¨ï¼Œå†…æ ¸ä¸­çš„gpioä½¿ç”¨ï¼Œå†…æ ¸ä¸­çš„pinctrlä½¿ç”¨ä»¥åŠdebug;<br>å¹¶é™„ä¸Šç®€å•çš„demoé©±åŠ¨ï¼Œæ–¹ä¾¿é©±åŠ¨å·¥ç¨‹å¸ˆå¿«é€Ÿä½¿ç”¨å…¨å¿—å¹³å°è¿›è¡Œgpioç›¸å…³çš„é©±åŠ¨å¼€å‘;</p>
<h1><span id="ubootä¸­gpioçš„ä½¿ç”¨">ubootä¸­gpioçš„ä½¿ç”¨</span></h1><p>å¯¹äºgpioçš„æ“ä½œï¼Œå°è£…åœ¨include/sys_config.h,ç”¨æˆ·å¯åœ¨æŸ¥é˜…å…¶ä»–é©±åŠ¨ï¼ˆå¦‚æ˜¾ç¤ºå±ï¼‰å€Ÿé‰´å®Œæˆæ‰€éœ€çš„ä»£ç ï¼›ä»¥ä¸‹æ˜¯ubootä¸­å®ç°gpio_ledçš„é‡ç­ç®€å•demoï¼›</p>
<h2><span id="ubootä¸­ä½¿ç”¨gpio-demo">ubootä¸­ä½¿ç”¨gpio demo</span></h2><p><strong>gpio_led.c</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#include &lt;common.h&gt;</span><br><span class="line">#include &lt;sys_config.h&gt;</span><br><span class="line">#include &lt;asm/arch/platform.h&gt;</span><br><span class="line">#include &lt;fdt_support.h&gt;    </span><br><span class="line">#include &lt;sys_config_old.h&gt;  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">static __u32 gpio_red_led_hd;</span><br><span class="line">static __u32 gpio_blue_led_hd;</span><br><span class="line"></span><br><span class="line">int gpio_led_init(void)&#123;</span><br><span class="line">    u8 ret;</span><br><span class="line">    user_gpio_set_t gpio_init;</span><br><span class="line">    memset(&amp;gpio_init, 0, sizeof(user_gpio_set_t)); </span><br><span class="line"></span><br><span class="line">    ret = script_parser_fetch(&quot;gpio_led&quot;, &quot;gpio_red_led&quot;, (void *)&amp;gpio_init, sizeof(user_gpio_set_t)&gt;&gt;2);</span><br><span class="line">    if (!ret) &#123;</span><br><span class="line">		//è·å–gpioå¥æŸ„</span><br><span class="line">        gpio_red_led_hd = gpio_request(&amp;gpio_init, 1); </span><br><span class="line">        if(!gpio_red_led_hd)&#123;</span><br><span class="line">            printf(&quot;gpio_red_led_hd request err\n&quot;);</span><br><span class="line">        &#125;   </span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        printf(&quot;gpio red init err\n&quot;);</span><br><span class="line">    &#125;   </span><br><span class="line">    ret = script_parser_fetch(&quot;gpio_led&quot;, &quot;gpio_blue_led&quot;, (void *)&amp;gpio_init, sizeof(user_gpio_set_t)&gt;&gt;2);</span><br><span class="line">    if (!ret) &#123;</span><br><span class="line">        gpio_blue_led_hd = gpio_request(&amp;gpio_init, 1); </span><br><span class="line">        if(!gpio_blue_led_hd)&#123;</span><br><span class="line">            printf(&quot;gpio_blue_led_hd request err\n&quot;);</span><br><span class="line">        &#125;   </span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        printf(&quot;gpio blue init err\n&quot;);</span><br><span class="line">    &#125;   </span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br><span class="line">int gpio_red_led_set_value(int value)&#123;</span><br><span class="line">    u8 ret;</span><br><span class="line">	è®¾ç½®gpio</span><br><span class="line">    ret = gpio_write_one_pin_value(gpio_red_led_hd, value, &quot;gpio_red_led&quot;); </span><br><span class="line">    if (ret) &#123;</span><br><span class="line">         printf(&quot;gpio_red_led_set_value%d err\n&quot;,value);</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br><span class="line">int gpio_blue_led_set_value(int value)&#123;</span><br><span class="line">    u8 ret;</span><br><span class="line">    ret = gpio_write_one_pin_value(gpio_blue_led_hd, value, &quot;gpio_blue_led&quot;);</span><br><span class="line">    if (ret) &#123;</span><br><span class="line">         printf(&quot;gpio_blue_led_set_value%d err\n&quot;,value);</span><br><span class="line">    &#125;</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>gpio_led.h</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#ifndef __GPIO_LED_H</span><br><span class="line">#define __GPIO_LED_H</span><br><span class="line">extern int gpio_led_init(void);</span><br><span class="line">extern int gpio_red_led_set_value(int value);</span><br><span class="line">extern int gpio_blue_led_set_value(int value); </span><br><span class="line">#endif</span><br></pre></td></tr></table></figure></p>
<p><strong>è°ƒç”¨æ¥å£æµç¨‹ï¼š</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">--- a/u-boot-2014.07/board/sunxi/common/secondary_main.c</span><br><span class="line">+++ b/u-boot-2014.07/board/sunxi/common/secondary_main.c</span><br><span class="line">@@ -34,6 +34,7 @@</span><br><span class="line"> #include &lt;asm/arch/platsmp.h&gt;</span><br><span class="line"> #include &lt;cputask.h&gt;</span><br><span class="line"> #include &lt;smc.h&gt;</span><br><span class="line">+#include &lt;gpio_led.h&gt;</span><br><span class="line"> #include &lt;securestorage.h&gt;</span><br><span class="line"> #include &lt;fdt_support.h&gt;</span><br><span class="line"> #include &lt;bmp_layout.h&gt;</span><br><span class="line">@@ -196,6 +197,7 @@ static int sunxi_probe_power_state(void)</span><br><span class="line">        int ret = 0, __power_on_cause;</span><br><span class="line">        SUNXI_BOOT_POWER_STATE_E __boot_state;</span><br><span class="line">        int pmu_bat_unused = 0;</span><br><span class="line">+       int gpio_led_used = 0;</span><br><span class="line"> </span><br><span class="line"> /* power_start</span><br><span class="line"> 0: not allow boot by insert dcin,boot condition:</span><br><span class="line">@@ -223,6 +225,13 @@ static int sunxi_probe_power_state(void)</span><br><span class="line">        __power_source = axp_probe_power_source();</span><br><span class="line">        pr_notice(&quot;PowerBus = %d( %d:vBus %d:acBus other: not exist)\n&quot;,</span><br><span class="line">                __power_source,AXP_VBUS_EXIST,AXP_DCIN_EXIST);</span><br><span class="line">+    script_parser_fetch(&quot;gpio_led&quot;, &quot;gpio_led_used&quot;, &amp;gpio_led_used, 1);</span><br><span class="line">+    if (gpio_led_used)&#123;</span><br><span class="line">+                printf(&quot;gpio_led_used 11\n&quot;);</span><br><span class="line">+                gpio_led_init();</span><br><span class="line">+                gpio_red_led_set_value(0);</span><br><span class="line">+                gpio_blue_led_set_value(1);</span><br><span class="line">+    &#125;</span><br></pre></td></tr></table></figure></p>
<p>å¦‚æœåœ¨ubootä¸­è°ƒç”¨äº†gpioè®¾ç½®æ–¹å‘ï¼Œé‚£ä¹ˆå†…æ ¸ä¸­probeå°±ä¸å¿…å»è°ƒç”¨gpio_direction_output(led_red,0)ï¼Œè¿™æ ·æ‰ä¸ä¼šå¯¼è‡´ubootä¸­è®¾ç½®çš„ç”µæºçŠ¶æ€è¢«ä¿®æ”¹ï¼›</p>
<h1><span id="å†…æ ¸ä¸­çš„gpioä½¿ç”¨">å†…æ ¸ä¸­çš„gpioä½¿ç”¨</span></h1><p>å¯¹äºé©±åŠ¨å·¥ç¨‹å¸ˆï¼Œä½¿ç”¨gpioé©±åŠ¨æ˜¯ä»¶æ— æ³•é€ƒé¿çš„ä¸€ä»¶äº‹æƒ…ï¼Œgpioçš„å¸¸è§æ“ä½œåŒ…æ‹¬ï¼Œè¾“å…¥è¾“å‡ºï¼Œé©±åŠ¨èƒ½åŠ›ï¼Œä¸Šä¸‹æ‹‰ï¼Œç”µå¹³ï¼›</p>
<h2><span id="å†…æ ¸ä¸­gpioçš„ä¸€èˆ¬ä½¿ç”¨æ­¥éª¤">å†…æ ¸ä¸­gpioçš„ä¸€èˆ¬ä½¿ç”¨æ­¥éª¤</span></h2><p><strong>ä¸€ï¼šæ·»åŠ æ‰€è¦ç”³è¯·çš„gpio</strong></p>
<p>æ–¹æ³•ä¸€ï¼šsys_config.fexæ·»åŠ å¯¹åº”çš„æè¿°</p>
<pre><code>pmu_type_c_sel             = port:PH10&lt;1&gt;&lt;default&gt;&lt;default&gt;&lt;0&gt;
</code></pre><p>æ–¹æ³•äºŒï¼šdtsçš„é…ç½®æ–¹æ³•</p>
<pre><code>pmu_type_c_sel=&lt;&amp;pio PH 10 1 1 1 0&gt;;
        |         |  |   | | | | |-------------------ç”µå¹³
        |         |  |   | | | |----------------------ä¸Šä¸‹æ‹‰
        |         |  |   | | |-------------------------é©±åŠ¨åŠ›
        |         |  |   | |----------------------------å¤ç”¨ç±»å‹ï¼Œ0-GPIOIN 1-GPIOOUT..
        |         |  |   |------------------------------pin bankå†…åç§».
        |         |  |---------------------------------å“ªä¸ªbank 
        |         |--------------------------------------æŒ‡å‘å“ªä¸ªpioï¼Œå±äºcpusè¦ç”¨&amp;r_pio
        |-----------------------------------------------------å±æ€§åå­—ï¼Œç›¸å½“sys_configå­é”®å
</code></pre><p><strong>äºŒï¼šè·å–ç›¸å…³çš„gpioç«¯å£</strong></p>
<pre><code> chg_dev-&gt;pmu_type_c_sel.gpio =
        of_get_named_gpio(pdev-&gt;dev.of_node, &quot;pmu_type_c_sel&quot;, 0);
if (!gpio_is_valid(chg_dev-&gt;pmu_type_c_sel.gpio)) {
        pr_err(&quot;get pmu_type_c_sel failed\n&quot;);
} else {
        ret = gpio_request(
                chg_dev-&gt;pmu_type_c_sel.gpio,
                &quot;pmu_type_c_sel&quot;);
        if (ret != 0) {
                pr_err(&quot;ERR: pmu_type_c_sel request failed\n&quot;);
                return -EINVAL;
        }   
        ret = gpio_direction_output(chg_dev-&gt;pmu_type_c_sel.gpio, 0); 
        if (ret &lt; 0) {
                pr_err(&quot;can&apos;t request output direction pmu_type_c_sel %d\n&quot;,
                                chg_dev-&gt;pmu_type_c_sel.gpio);
                return ret;
        }   
}   
</code></pre><p><strong>ä¸‰ï¼šæ ¹æ®éœ€æ±‚è®¾ç½®ç›¸å…³çš„ç”µå¹³</strong></p>
<pre><code>static int bmu1760_set_sel_mode(struct axp_charger_dev *cdev, int mode)
{
    if (mode) {
            gpio_set_value(cdev-&gt;pmu_type_c_sel.gpio, 1); 
    } else {
            gpio_set_value(cdev-&gt;pmu_type_c_sel.gpio, 0); 
    }   
    AXP_DEBUG(AXP_SPLY, cdev-&gt;chip-&gt;pmu_num,
            &quot;set_sel_mode = %x\n&quot;, mode);
    return 0;
}
</code></pre><p><strong>å››ï¼šè®¾ç½®ç®¡è„šçš„é©±åŠ¨èƒ½åŠ›</strong></p>
<p>æ­£å¸¸ä»¥ä¸Šä¸‰ä¸ªæ­¥éª¤å·²ç»æ»¡è¶³åŸºæœ¬éœ€æ±‚ï¼Œä½†å¦‚æœå¯¹ç®¡è„šçš„é©±åŠ¨èƒ½åŠ›ä¸æ»¡æ„ï¼›ä»¥ä¸‹å¯¹PLç®¡è„šè¿›è¡Œè®¾ç½®</p>
<pre><code>DTSè®¾ç½®å¦‚ä¸‹ï¼š
gpio_led_led = &lt;&amp;r_pio PL 10 1 1 3 0&gt;

--- a/drivers/misc/sunxi-rf/sunxi-wlan.c
+++ b/drivers/misc/sunxi-rf/sunxi-wlan.c
@@ -367,6 +367,8 @@ static int sunxi_wlan_probe(struct platform_device *pdev)
        struct device *dev = &amp;pdev-&gt;dev;
        struct sunxi_wlan_platdata *data;
        struct gpio_config config;
+       unsigned long drv_level;
+       char pin_name[SUNXI_PIN_NAME_MAX_LEN];
        u32 val;
        const char *power, *io_regulator;
        int ret = 0;
@@ -439,6 +441,14 @@ static int sunxi_wlan_probe(struct platform_device *pdev)
                                data-&gt;gpio_wlan_regon);
                        return ret;
                }   
+               printk(&quot;%s %d\n&quot;,__func__,__LINE__);
+               sunxi_gpio_to_name(config.gpio, pin_name);
+               if (config.drv_level != GPIO_DRVLVL_DEFAULT) {
+                       printk(&quot;%s %d\n&quot;,__func__,__LINE__);
+                       drv_level = SUNXI_PINCFG_PACK(SUNXI_PINCFG_TYPE_DRV, config.drv_level);
+                       pin_config_set(SUNXI_R_PINCTRL, pin_name, drv_level);
+               }
+
    }   
</code></pre><p>å¦‚æœä½¿ç”¨pinctrlçš„è®¾ç½®æ–¹å¼çš„è¯ï¼Œpinctrlä¼šä¸ºæˆ‘ä»¬åˆå§‹åŒ–å¥½è®¾ç½®çš„ä¸œè¥¿,GPIOçš„è®¾ç½®æ–¹å¼åˆ™éœ€è¦æ‰‹åŠ¨é…ç½®ï¼›</p>
<p>è®²å®Œè¾“å‡ºä»¥åŠç”µå¹³çš„è®¾ç½®ï¼Œå¦å¤–ä¸€ä¸ªç®¡è„šå¸¸ç”¨çš„åŠŸèƒ½ä¸­æ–­çš„ç”³è¯·æ­¥éª¤è¿™é‡Œä¹Ÿé¡ºä¾¿è®²ä¸€ä¸‹</p>
<h2><span id="ä¸­æ–­ç®¡è„šç”³è¯·æµç¨‹">ä¸­æ–­ç®¡è„šç”³è¯·æµç¨‹</span></h2><pre><code>dtsé…ç½®å¦‚ä¸‹
     pmu_acin_det               = &lt;&amp;pio PH 10 0 1 1 0&gt;

chg_dev-&gt;axp_acin_det.gpio =  of_get_named_gpio(pdev-&gt;dev.of_node,
                            &quot;pmu_acin_det_gpio&quot;, 0);
if (!gpio_is_valid(chg_dev-&gt;axp_acin_det.gpio)) {
    pr_err(&quot;ERR: get pmu_acin_det_gpio is fail\n&quot;);
    return -EINVAL;
}

 ret = gpio_request( chg_dev-&gt;axp_acin_det.gpioï¼Œ &quot;pmu_acin_det_gpio&quot;);
 if (ret != 0) {
     pr_err(&quot;ERR: pmu_acin_det gpio_request failed\n&quot;);
     return -EINVAL;
}
id_irq_num = gpio_to_irq(chg_dev-&gt;axp_acin_det.gpio);
if (IS_ERR_VALUE((unsigned long)id_irq_num)) {
    pr_err(&quot;ERR: map pmu_acin_det gpio to virq failed, err %d\n&quot;,
               id_irq_num);
    return -EINVAL;
}
ret = request_irq(id_irq_num, axp_acin_gpio_isr, irq_flags,
            &quot;pmu_acin_det_gpio&quot;, chg_dev);
if (IS_ERR_VALUE((unsigned long)ret)) {
    pr_err(&quot;ERR: request pmu_acin_det virq %d failed, err %d\n&quot;,
             id_irq_num, ret);
    return -EINVAL;
}
</code></pre><p><strong>gpioéœ€è¦åœ¨ä¼‘çœ æ—¶å”¤é†’ç³»ç»Ÿï¼š</strong></p>
<pre><code>å…¨å¿—ç›®å‰çš„è¯åªæ”¯æŒå°cpuçš„gpioå£å”¤é†’ç³»ç»Ÿï¼Œå¦‚æœè¦å”¤é†’ç³»ç»Ÿï¼Œéœ€è¦åŠ å…¥è¿™ä¸¤ä¸ªæ­¥éª¤

ä¸€ï¼šenable_gpio_wakeup_src(data-&gt;gpio_wlan_hostwake);
äºŒï¼šrequest_irqçš„æ—¶å€™éœ€è¦åŠ å…¥æ ‡å¿—ä½ IRQF_NO_SUSPEND
</code></pre><p>è®²å®Œä½¿ç”¨çš„æ­¥éª¤ï¼Œæˆ‘ä»¬è®²ä¸‹GPIOçš„å‡½æ•°è°ƒç”¨æµç¨‹ï¼Œé¡ºä¾¿å¸¦å‡ºpinctrl</p>
<pre><code>gpio_set_value
    __gpio_set_value
        gpiod_set_raw_value
            _gpiod_set_raw_value
                chip-&gt;set(chip, gpio_chip_hwgpio(desc), value);
                    sunxi_pinctrl_gpio_set
                        writel(regval, pctl-&gt;membase + reg); 
</code></pre><p>ä»ä»¥ä¸Šæµç¨‹å¯çŸ¥ï¼ŒGPIOçš„APIæ˜¯å»ºç«‹åœ¨pinctrlä¹‹ä¸Šçš„æ¥å£ï¼Œå…¶ä»–æµç¨‹ä¹Ÿç±»ä¼¼ï¼Œä¸åœ¨èµ˜è¿°ï¼Œå¼€å§‹è®²pinctrl</p>
<h1><span id="pinctrl">pinctrl</span></h1><p>ä»ä¸Šé¢çš„gpioçš„è°ƒç”¨æµç¨‹æˆ‘ä»¬å¯ä»¥çœ‹åˆ°gpioç±»ä¼¼äºpinctrlçš„clientæˆ–è€…consumerï¼›ä½†å¯¹äºç®¡è„šï¼Œå…¶ä¸æ­¢æœ‰gpioçš„åŸºæœ¬åŠŸèƒ½ï¼Œè¾“å…¥è¾“å‡ºï¼›å½“gpioç»„åˆçš„æ—¶å€™ï¼Œé…åˆèŠ¯ç‰‡çš„æ§åˆ¶å™¨ï¼Œä»–å¯ä»¥ä½œä¸ºIIC,SPIçš„æ§åˆ¶å¼•è„šï¼›</p>
<h2><span id="pinctrlä½œç”¨">pinctrlä½œç”¨</span></h2><ol>
<li>ç®¡ç†ç³»ç»Ÿä¸­æ‰€æœ‰çš„å¯ä»¥æ§åˆ¶çš„pin,åœ¨ç³»ç»Ÿåˆå§‹åŒ–çš„æ—¶å€™ï¼Œæšä¸¾æ‰€æœ‰å¯ä»¥æ§åˆ¶çš„pin,å¹¶æ ‡è¯†è¿™äº›pin.</li>
<li>ç®¡ç†è¿™äº›pinçš„å¤ç”¨ï¼ˆMultiplexingï¼‰ï¼Œå¯¹äºSOCè€Œè¨€ï¼Œå…¶å¼•è„šé™¤äº†é…ç½®æˆæ™®é€šçš„GPIOä¹‹å¤–ï¼Œè‹¥å¹²ä¸ªå¼•è„šè¿˜å¯ä»¥ç»„æˆä¸€ä¸ªpin group,è¡Œç¨‹ç‰¹å®šçš„åŠŸèƒ½ã€‚pin control subsysteméœ€ç®¡ç†æ‰€æœ‰çš„pin groupã€‚</li>
<li>é…ç½®è¿™äº›pinçš„ç‰¹æ€§ï¼Œä¾‹å¦‚ä½¿èƒ½æˆ–å…³é—­å¼•è„šä¸Šçš„pull-up,pull-downç”µé˜»ï¼Œé…ç½®å¼•è„šçš„driver strengthï¼›</li>
</ol>
<h2><span id="pinctrçš„ä½¿ç”¨demo">pinctrçš„ä½¿ç”¨demo:</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">static int ir_tx_request_gpio(struct sunxi_ir_tx_data *ir_tx_data)     </span><br><span class="line">&#123;                                                                      </span><br><span class="line">        ir_tx_data-&gt;pctrl = devm_pinctrl_get(&amp;ir_tx_data-&gt;pdev-&gt;dev);  </span><br><span class="line">        if (IS_ERR(ir_tx_data-&gt;pctrl)) &#123;                               </span><br><span class="line">                IRTX_ERR(&quot;devm_pinctrl_get() failed!\n&quot;);              </span><br><span class="line">                return -1;                                             </span><br><span class="line">        &#125;                                                              </span><br><span class="line">                                                                       </span><br><span class="line">        return ir_tx_select_gpio_state(ir_tx_data-&gt;pctrl,              </span><br><span class="line">                        PINCTRL_STATE_DEFAULT);                        </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static int ir_tx_select_gpio_state(struct pinctrl *pctrl, char *name)           </span><br><span class="line">&#123;                                                                               </span><br><span class="line">        int ret = 0;                                                            </span><br><span class="line">        struct pinctrl_state *pctrl_state = NULL;                               </span><br><span class="line">                                                                                </span><br><span class="line">        pctrl_state = pinctrl_lookup_state(pctrl, name);                        </span><br><span class="line">        if (IS_ERR(pctrl_state)) &#123;                                              </span><br><span class="line">                IRTX_ERR(&quot;IR_TX pinctrl_lookup_state(%s) failed! return %p \n&quot;, </span><br><span class="line">                                name, pctrl_state);                             </span><br><span class="line">                return -1;                                                      </span><br><span class="line">        &#125;                                                                       </span><br><span class="line">                                                                                </span><br><span class="line">        ret = pinctrl_select_state(pctrl, pctrl_state);                         </span><br><span class="line">        if (ret &lt; 0)                                                            </span><br><span class="line">                IRTX_ERR(&quot;IR_TX pinctrl_select_state(%s) failed! return %d \n&quot;, </span><br><span class="line">                                name, ret);                                     </span><br><span class="line">                                                                                </span><br><span class="line">        return ret;                                                             </span><br><span class="line">&#125;</span><br><span class="line">static int sunxi_ir_tx_remove(struct platform_device *pdev)              </span><br><span class="line">&#123;                                                                        </span><br><span class="line">        struct sunxi_ir_tx_data *ir_tx_data = platform_get_drvdata(pdev);</span><br><span class="line">                                                                   </span><br><span class="line">   		....                     </span><br><span class="line">        devm_pinctrl_put(ir_tx_data-&gt;pctrl);                             </span><br><span class="line">                                                                                                                  </span><br><span class="line">        ....                                                                     </span><br><span class="line">        return 0;                                                        </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2><span id="pinctrl-debug-æ–¹æ³•">pinctrl debug æ–¹æ³•</span></h2><p><img src="/2018/02/25/pinctrl/sunxi_pinctrl/sunxi_pinctrl_debug.jpg" alt="pinctrl debug"></p>
<p>#å‚è€ƒèµ„æ–™</p>
<p><a href="http://www.wowotech.net/gpio_subsystem/pinctrl-and-gpio.html" target="_blank" rel="noopener">linuxå†…æ ¸ä¸­çš„GPIOç³»ç»Ÿä¹‹ï¼ˆ5ï¼‰ï¼šgpio subsysemå’Œpinctrl subsystemä¹‹é—´çš„è€¦åˆ</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">dongka</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">20</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">11</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">12</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">dongka</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
